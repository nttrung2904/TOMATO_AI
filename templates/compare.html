{% extends "base.html" %}

{% block content %}

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert--error">
      {% for msg in messages %}
        <div>{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="hero card">
  <div style="display:flex;gap:20px;align-items:center;">
    <div style="flex:1;">
      <h1 style="margin:0 0 8px 0;color:var(--tomato-700)">üî¨ So s√°nh Models v√† Pipelines</h1>
      <p class="desc">Upload 1 ·∫£nh v√† ch·ªçn nhi·ªÅu models/pipelines ƒë·ªÉ so s√°nh k·∫øt qu·∫£ d·ª± ƒëo√°n. H·ªá th·ªëng s·∫Ω ch·∫°y ·∫£nh qua t·∫•t c·∫£ t·ªï h·ª£p v√† hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt.</p>
      <div style="padding:10px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;font-size:0.9em;margin-top:12px;">
        <strong>‚ö° L∆∞u √Ω:</strong> M·ªói t·ªï h·ª£p model √ó pipeline s·∫Ω m·∫•t 1-3 gi√¢y. H·∫°n ch·∫ø t·ªëi ƒëa 20 t·ªï h·ª£p (v√≠ d·ª•: 4 models √ó 5 pipelines).
      </div>
    </div>
    <div style="width:320px">
      <img src="https://www.agrodigital.com/wp-content/uploads/2020/02/Tomate.jpg" 
           style="width:100%;height:200px;object-fit:cover;border-radius:12px;" 
           alt="Compare models">
    </div>
  </div>
</section>

<section style="display:flex;gap:24px;margin-top:18px;align-items:flex-start;">
  <div style="flex:1;min-width:400px">
    <form id="compare-form" action="{{ url_for('compare_predict') }}" method="post" enctype="multipart/form-data">
      <div class="card">
        <h3 style="margin-top:0;">1Ô∏è‚É£ Ch·ªçn ·∫£nh</h3>
        <div class="file-drop-area">
          <span class="file-msg">K√©o v√† th·∫£ ·∫£nh v√†o ƒë√¢y, ho·∫∑c <strong class="btn-like">nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</strong></span>
          <input id="file" name="file" type="file" class="file-input" accept="image/*" required onchange="onFileChange(event)">
        </div>
        <div id="file-info" style="margin-top:10px; text-align:center; display:none;">
          <span id="file-name" style="font-weight:600;"></span>
          <button type="button" id="remove-file-btn" class="btn small danger" style="margin-left:8px;">X√≥a</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3 style="margin-top:0;">2Ô∏è‚É£ Ch·ªçn Models ƒë·ªÉ so s√°nh</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
          {% for model in models %}
          <label style="display:flex;align-items:center;padding:8px;background:#f5f5f5;border-radius:6px;cursor:pointer;">
            <input type="checkbox" name="models" value="{{ model }}" 
                   {% if model == last_model %}checked{% endif %}
                   onchange="updateCount()"
                   style="margin-right:8px;">
            <span>{{ model }}</span>
          </label>
          {% endfor %}
        </div>
        <div style="margin-top:8px;">
          <button type="button" onclick="selectAllModels()" class="btn small" style="margin-right:8px;">Ch·ªçn t·∫•t c·∫£</button>
          <button type="button" onclick="deselectAllModels()" class="btn small danger">B·ªè ch·ªçn t·∫•t c·∫£</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3 style="margin-top:0;">3Ô∏è‚É£ Ch·ªçn Pipelines ƒë·ªÉ so s√°nh</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
          {% for pipeline in pipelines %}
          <label style="display:flex;align-items:center;padding:8px;background:#f5f5f5;border-radius:6px;cursor:pointer;">
            <input type="checkbox" name="pipelines" value="{{ pipeline }}" 
                   {% if pipeline == last_pipeline %}checked{% endif %}
                   onchange="updateCount()"
                   style="margin-right:8px;">
            <span>{{ pipeline }}</span>
          </label>
          {% endfor %}
        </div>
        <div style="margin-top:8px;">
          <button type="button" onclick="selectAllPipelines()" class="btn small" style="margin-right:8px;">Ch·ªçn t·∫•t c·∫£</button>
          <button type="button" onclick="deselectAllPipelines()" class="btn small danger">B·ªè ch·ªçn t·∫•t c·∫£</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px;background:#e3f2fd;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:0.9rem;color:#666;margin-bottom:4px;">T·ªïng s·ªë t·ªï h·ª£p s·∫Ω ch·∫°y:</div>
            <div style="font-size:2rem;font-weight:700;color:var(--tomato-700);" id="total-count">0</div>
            <div style="font-size:0.85rem;color:#666;" id="estimate-time">∆Ø·ªõc t√≠nh: 0 gi√¢y</div>
          </div>
          <div>
            <button type="submit" id="compare-btn" class="btn" style="font-size:1.1rem;padding:12px 24px;">
              üîç So s√°nh ngay
            </button>
          </div>
        </div>
      </div>

      <div id="loading" style="display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; margin-top:16px;" class="card">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-size:1.2em; color:var(--tomato-700);">ƒêang ch·∫°y so s√°nh...</p>
        <p style="color:#666;font-size:0.9rem;">Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t</p>
      </div>
    </form>
  </div>

  <aside style="width:320px">
    <div class="card">
      <h3 style="margin-top:0; text-align:center;">·∫¢nh ƒë·∫ßu v√†o</h3>
      <div id="preview-container" style="display:flex;justify-content:center;align-items:center;min-height:200px;background-color:#f9f9f9;border-radius:8px;">
        <img id="preview" class="preview" src="#" alt="Preview" style="display:none;max-width:100%;max-height:250px;border-radius:8px;"/>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin-top:0">üí° M·∫πo s·ª≠ d·ª•ng</h3>
      <ul style="font-size:0.9rem;">
        <li>Ch·ªçn 2-3 models t·ªët nh·∫•t ƒë·ªÉ so s√°nh nhanh</li>
        <li>So s√°nh nhi·ªÅu pipelines gi√∫p t√¨m c·∫•u h√¨nh t·ªëi ∆∞u</li>
        <li>V·ªõi ·∫£nh kh√≥, h√£y ch·∫°y qua nhi·ªÅu t·ªï h·ª£p ƒë·ªÉ c√≥ k·∫øt qu·∫£ ch√≠nh x√°c h∆°n</li>
        <li>K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c s·∫Øp x·∫øp theo ƒë·ªô tin c·∫≠y</li>
      </ul>
    </div>
  </aside>
</section>

{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file');
    const fileNameEl = document.getElementById('file-name');
    const fileInfoEl = document.getElementById('file-info');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    const removeBtn = document.getElementById('remove-file-btn');
    const fileDropArea = document.querySelector('.file-drop-area');

    function handleFile(file) {
      if (file) {
        fileNameEl.textContent = file.name;
        fileInfoEl.style.display = 'block';
        fileDropArea.classList.add('has-file');

        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        previewContainer.style.background = 'none';
      }
    }

    function resetFile() {
        fileInput.value = '';
        fileNameEl.textContent = '';
        fileInfoEl.style.display = 'none';
        fileDropArea.classList.remove('has-file');

        preview.src = '#';
        preview.style.display = 'none';
        previewContainer.style.background = '#f9f9f9';
    }

    function onFileChange(e){
      const file = e.target.files && e.target.files.length ? e.target.files[0] : null;
      handleFile(file);
    }

    removeBtn.addEventListener('click', resetFile);

    // Click on drop area to trigger file input
    fileDropArea.addEventListener('click', () => {
      fileInput.click();
    });

    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('highlight'), false);
    });
    fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('highlight'), false);
    fileDropArea.addEventListener('drop', (e) => {
        fileDropArea.classList.remove('highlight');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFile(files[0]);
        }
    }, false);

    // Model/Pipeline selection
    function selectAllModels() {
        document.querySelectorAll('input[name="models"]').forEach(cb => cb.checked = true);
        updateCount();
    }

    function deselectAllModels() {
        document.querySelectorAll('input[name="models"]').forEach(cb => cb.checked = false);
        updateCount();
    }

    function selectAllPipelines() {
        document.querySelectorAll('input[name="pipelines"]').forEach(cb => cb.checked = true);
        updateCount();
    }

    function deselectAllPipelines() {
        document.querySelectorAll('input[name="pipelines"]').forEach(cb => cb.checked = false);
        updateCount();
    }

    function updateCount() {
        const modelCount = document.querySelectorAll('input[name="models"]:checked').length;
        const pipelineCount = document.querySelectorAll('input[name="pipelines"]:checked').length;
        const total = modelCount * pipelineCount;
        
        document.getElementById('total-count').textContent = total;
        document.getElementById('estimate-time').textContent = `∆Ø·ªõc t√≠nh: ${Math.round(total * 1.5)} - ${total * 3} gi√¢y`;
        
        const compareBtn = document.getElementById('compare-btn');
        if (total > 20) {
            compareBtn.disabled = true;
            compareBtn.style.opacity = '0.5';
            compareBtn.textContent = '‚ùå Qu√° nhi·ªÅu t·ªï h·ª£p (max: 20)';
        } else if (total === 0) {
            compareBtn.disabled = true;
            compareBtn.style.opacity = '0.5';
            compareBtn.textContent = '‚ö†Ô∏è Ch·ªçn √≠t nh·∫•t 1 t·ªï h·ª£p';
        } else {
            compareBtn.disabled = false;
            compareBtn.style.opacity = '1';
            compareBtn.textContent = `üîç So s√°nh ${total} t·ªï h·ª£p`;
        }
    }

    // Form submit
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('compare-form');
        const loading = document.getElementById('loading');
        const compareBtn = document.getElementById('compare-btn');

        form.addEventListener('submit', function() {
            loading.style.display = 'flex';
            compareBtn.disabled = true;
        });

        // Initial count
        updateCount();
    });
</script>
{% endblock %}
