{% extends "base.html" %}

{% block content %}

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert--error">
          {% for msg in messages %}
            <div>{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="hero card">
      <div style="display:flex;gap:20px;align-items:center;">
        <div style="flex:1; padding-right: 20px;">
          <h1 style="margin:0 0 8px 0;color:var(--tomato-700)">Nh·∫≠n di·ªán b·ªánh tr√™n l√° c√† chua b·∫±ng c√°c m√¥ h√¨nh h·ªçc s√¢u</h1>
          <p class="desc">T·∫£i ·∫£nh l√° c√† chua, ch·ªçn model v√† pipeline. H·ªá th·ªëng s·∫Ω ƒë∆∞a ra d·ª± ƒëo√°n v√† h∆∞·ªõng d·∫´n ph√≤ng ng·ª´a.</p>
          <ol style="margin-top:12px">
            <li>·∫¢nh ƒë·∫ßu v√†o n√™n d·ªÖ nh√¨n v√† r√µ n√©t (s√°ng, kh√¥ng qu√° m·ªù ƒë·ªÉ m√¥ h√¨nh nh·∫≠n d·∫°ng ch√≠nh x√°c h∆°n).</li>
            <li>Ch·ªçn model v√† pipeline ph√π h·ª£p.</li>
            <li>Nh·∫•n D·ª± ƒëo√°n ƒë·ªÉ xem k·∫øt qu·∫£ v√† bi·ªán ph√°p x·ª≠ l√Ω.</li>
          </ol>
        </div>
        <div style="width:420px">
          <img src="https://inkythuatso.com/uploads/thumbnails/800/2023/03/4-hinh-anh-qua-ca-chua-tren-canh-inkythuatso-30-10-13-45.jpg" style="width:100%;height:240px;object-fit:cover;border-radius:12px;" alt="Tomato hero">
        </div>
      </div>
    </section>

    <section style="display:flex;gap:24px;margin-top:18px;align-items:flex-start;">
      <div style="flex:1;min-width:360px">
        <div class="card"> 
          <form id="upload-form" action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" style="margin-bottom: 0;">
            <!-- C·∫£i ti·∫øn v√πng upload ·∫£nh, h·ªó tr·ª£ k√©o th·∫£ -->
            <div class="file-drop-area">
              <span class="file-msg">K√©o v√† th·∫£ ·∫£nh v√†o ƒë√¢y, ho·∫∑c <strong class="btn-like">nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</strong></span>
              <input id="file" name="file" type="file" class="file-input" accept="image/*" onchange="onFileChange(event)">
            </div>
            <div id="file-info" style="margin-top:10px; text-align:center; display:none;">
              <span id="file-name" style="font-weight:600;"></span>
              <button type="button" id="remove-file-btn" class="btn small danger" style="margin-left:8px;">X√≥a</button>
            </div>
            
            <!-- Ph·∫ßn ch·ªçn model v√† pipeline -->
            <div style="margin-top:12px;display:flex;gap:12px;">
              <div style="flex:1">
                <label>Ch·ªçn model:</label>
                <select name="model_select" required id="model-select">
                  {% for m in models %}
                    <option value="{{m}}" {% if m == last_model %}selected{% endif %}>{{m}}</option>
                  {% endfor %}
                </select>
              </div>
              <div style="width:220px">
                <label>Pipeline:</label>
                <select name="pipeline_select" required>
                  {% for p in pipelines %}
                    <option value="{{p}}" {% if p == last_pipeline %}selected{% endif %}>{{p}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <!-- Th√¥ng b√°o khuy·∫øn ngh·ªã -->
            <div style="margin-top:10px;padding:10px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;font-size:0.9em;">
              <strong>üí° L∆∞u √Ω:</strong> 
              <ul style="margin:5px 0 0 20px;padding:0;">
                <li>N·∫øu ·∫£nh b·ªã t·ª´ ch·ªëi, h√£y th·ª≠ ch·ª•p l·∫°i ho·∫∑c ch·ªçn ·∫£nh l√° r√µ r√†ng h∆°n</li>
                <li><strong>Khuy·∫øn ngh·ªã:</strong> V·ªõi ·∫£nh kh√¥ng r√µ, th·ª≠ nhi·ªÅu models ƒë·ªÉ so s√°nh k·∫øt qu·∫£</li>
              </ul>
            </div>
            
            <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
              <button type="submit" id="predict-btn" class="btn" style="width: 120px;">D·ª± ƒëo√°n</button>
              <div style="flex:1;text-align:right"><small class="desc">Ch·ªçn ·∫£nh l√° r√µ ƒë·ªÉ k·∫øt qu·∫£ ch√≠nh x√°c h∆°n.</small></div>
        </div>
          </form>
          <div id="loading" style="display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;">
            <div class="spinner"></div>
            <p style="margin-top:10px; font-size:1.2em; color:var(--tomato-700);">Xin vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
          </div>
        </div>
        
        <div style="margin-top:14px" class="card">
          <h3 style="margin-top:0">M·∫πo ch·ª•p ·∫£nh</h3>
          <ul>
            <li>√Ånh s√°ng t·ª± nhi√™n, tr√°nh b√≥ng t·ªëi v√πng l√°.</li>
            <li>Ch·ª•p to√†n b·ªô l√° ho·∫∑c ph·∫ßn c√≥ t·ªïn th∆∞∆°ng r√µ r√†ng.</li>
            <li>Kh√¥ng ch·ª•p qu√° s√°t l√†m m·∫•t b·ªëi c·∫£nh.</li>
          </ul>
        </div>
      </div>

      <aside style="width:320px">
        <div class="card">
          <h3 style="margin-top:0; text-align:center;">·∫¢nh ƒë·∫ßu v√†o</h3>
          <div id="preview-container" style="display:flex;justify-content:center;align-items:center;min-height:200px;background-color:#f9f9f9;border-radius:8px;">
            <img id="preview" class="preview" src="#" alt="Preview" style="display:none;max-width:100%;max-height:250px;border-radius:8px;"/>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">B·ªô s∆∞u t·∫≠p</h3>
          <div class="tomato-gallery">
            <img src="https://tse2.mm.bing.net/th/id/OIP.fiTPNS81lLkNK5R4ZYQYpwHaFj?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Tomato leaf">
            <img src="https://congtydelta.com/public/upload/slide/benh-heo-vang-tren-cay-ca-chua-kimnonggoldstar-vn-2-1.jpg" alt="Tomato disease">
            <img src="https://bloganchoi.com/wp-content/uploads/2016/06/ca-chua-dep.jpg" alt="Tomato">
          </div>
        </div>
      </aside>
    </section>

{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file');
    const fileNameEl = document.getElementById('file-name');
    const fileInfoEl = document.getElementById('file-info');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    const removeBtn = document.getElementById('remove-file-btn');
    const fileDropArea = document.querySelector('.file-drop-area');

    function handleFile(file) {
      if (file) {
        fileNameEl.textContent = file.name;
        fileInfoEl.style.display = 'block';
        fileDropArea.classList.add('has-file');

        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        previewContainer.style.background = 'none';
      }
    }

    function resetFile() {
        fileInput.value = ''; // Quan tr·ªçng ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng 1 file
        fileNameEl.textContent = '';
        fileInfoEl.style.display = 'none';
        fileDropArea.classList.remove('has-file');

        preview.src = '#';
        preview.style.display = 'none';
        previewContainer.style.background = '#f9f9f9';
    }

    function onFileChange(e){
      const file = e.target.files && e.target.files.length ? e.target.files[0] : null;
      handleFile(file);
    }

    removeBtn.addEventListener('click', resetFile);

    // S·ª± ki·ªán k√©o th·∫£ (drag and drop)
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('highlight'), false);
    });
    fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('highlight'), false);
    fileDropArea.addEventListener('drop', (e) => {
        fileDropArea.classList.remove('highlight');
        handleFile(e.dataTransfer.files[0]);
    }, false);

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const loading = document.getElementById('loading');
        const predictBtn = document.getElementById('predict-btn');

        form.addEventListener('submit', function() {
            loading.style.display = 'flex'; // Hi·ªÉn th·ªã th√¥ng b√°o ch·ªù
            predictBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t D·ª± ƒëo√°n
        });
    });
</script>
{% endblock %}
