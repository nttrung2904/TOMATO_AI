{% extends "base.html" %}

{% block content %}

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert--error">
          {% for msg in messages %}
            <div>{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="hero card">
      <div style="display:flex;gap:20px;align-items:center;">
        <div style="flex:1; padding-right: 20px;">
          <h1 style="margin:0 0 8px 0;color:var(--tomato-700)">Nh·∫≠n di·ªán b·ªánh tr√™n l√° c√† chua b·∫±ng c√°c m√¥ h√¨nh h·ªçc s√¢u</h1>
          <p class="desc">T·∫£i ·∫£nh l√° c√† chua, ch·ªçn model v√† pipeline. H·ªá th·ªëng s·∫Ω ƒë∆∞a ra d·ª± ƒëo√°n v√† h∆∞·ªõng d·∫´n ph√≤ng ng·ª´a.</p>
          <ol style="margin-top:12px">
            <li>·∫¢nh ƒë·∫ßu v√†o n√™n d·ªÖ nh√¨n v√† r√µ n√©t (s√°ng, kh√¥ng qu√° m·ªù ƒë·ªÉ m√¥ h√¨nh nh·∫≠n d·∫°ng ch√≠nh x√°c h∆°n).</li>
            <li>Ch·ªçn model v√† pipeline ph√π h·ª£p.</li>
            <li>Nh·∫•n D·ª± ƒëo√°n ƒë·ªÉ xem k·∫øt qu·∫£ v√† bi·ªán ph√°p x·ª≠ l√Ω.</li>
          </ol>
        </div>
        <div style="width:420px">
          <img src="https://inkythuatso.com/uploads/thumbnails/800/2023/03/4-hinh-anh-qua-ca-chua-tren-canh-inkythuatso-30-10-13-45.jpg" style="width:100%;height:240px;object-fit:cover;border-radius:12px;" alt="Tomato hero">
        </div>
      </div>
    </section>

    <section style="display:flex;gap:24px;margin-top:18px;align-items:flex-start;">
      <div style="flex:1;min-width:360px">
        <div class="card"> 
          <!-- Toggle gi·ªØa Single v√† Batch mode -->
          <div style="margin-bottom:16px;display:flex;gap:8px;background:#f5f5f5;padding:4px;border-radius:8px;">
            <button type="button" id="single-mode-btn" class="mode-toggle-btn active" onclick="switchMode('single')">
              üì∑ M·ªôt ·∫£nh
            </button>
            <button type="button" id="batch-mode-btn" class="mode-toggle-btn" onclick="switchMode('batch')">
              üìö Nhi·ªÅu ·∫£nh (t·ªëi ƒëa 10)
            </button>
          </div>

          <!-- Form Single Prediction -->
          <form id="upload-form" action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" style="margin-bottom: 0;">
            <!-- C·∫£i ti·∫øn v√πng upload ·∫£nh, h·ªó tr·ª£ k√©o th·∫£ -->
            <div class="file-drop-area">
              <span class="file-msg">K√©o v√† th·∫£ ·∫£nh v√†o ƒë√¢y, ho·∫∑c <strong class="btn-like">nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</strong></span>
              <input id="file" name="file" type="file" class="file-input" accept="image/*" onchange="onFileChange(event)">
            </div>
            <div id="file-info" style="margin-top:10px; text-align:center; display:none;">
              <span id="file-name" style="font-weight:600;"></span>
              <button type="button" id="remove-file-btn" class="btn small danger" style="margin-left:8px;">X√≥a</button>
            </div>
            
            <!-- Ph·∫ßn ch·ªçn model v√† pipeline -->
            <div style="margin-top:12px;display:flex;gap:12px;">
              <div style="flex:1">
                <label>Ch·ªçn model:</label>
                <select name="model" required id="model-select">
                  {% for m in models %}
                    <option value="{{m}}" {% if m == last_model %}selected{% endif %}>{{m}}</option>
                  {% endfor %}
                </select>
              </div>
              <div style="width:220px">
                <label>Pipeline:</label>
                <select name="pipeline" required>
                  {% for p in pipelines %}
                    <option value="{{p}}" {% if p == last_pipeline %}selected{% endif %}>{{p}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <!-- Th√¥ng b√°o khuy·∫øn ngh·ªã -->
            <div style="margin-top:10px;padding:10px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;font-size:0.9em;">
              <strong>üí° L∆∞u √Ω:</strong> 
              <ul style="margin:5px 0 0 20px;padding:0;">
                <li>N·∫øu ·∫£nh b·ªã t·ª´ ch·ªëi, h√£y th·ª≠ ch·ª•p l·∫°i ho·∫∑c ch·ªçn ·∫£nh l√° r√µ r√†ng h∆°n</li>
                <li><strong>Khuy·∫øn ngh·ªã:</strong> V·ªõi ·∫£nh kh√¥ng r√µ, th·ª≠ nhi·ªÅu models ƒë·ªÉ so s√°nh k·∫øt qu·∫£</li>
              </ul>
            </div>
            
            <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
              <button type="submit" id="predict-btn" class="btn" style="width: 120px;">D·ª± ƒëo√°n</button>
              <div style="flex:1;text-align:right"><small class="desc">Ch·ªçn ·∫£nh l√° r√µ ƒë·ªÉ k·∫øt qu·∫£ ch√≠nh x√°c h∆°n.</small></div>
            </div>
          </form>

          <!-- Form Batch Prediction -->
          <form id="batch-form" action="{{ url_for('batch_predict') }}" method="post" enctype="multipart/form-data" style="margin-bottom: 0; display:none;">
            <div class="file-drop-area" id="batch-drop-area">
              <span class="file-msg">K√©o v√† th·∫£ nhi·ªÅu ·∫£nh v√†o ƒë√¢y, ho·∫∑c <strong class="btn-like">nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</strong></span>
              <input id="batch-files" name="images" type="file" class="file-input" accept="image/*" multiple onchange="onBatchFileChange(event)">
            </div>
            <div id="batch-file-info" style="margin-top:10px; display:none;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-weight:600;">ƒê√£ ch·ªçn: <span id="batch-count">0</span> ·∫£nh</span>
                <button type="button" id="remove-batch-btn" class="btn small danger">X√≥a t·∫•t c·∫£</button>
              </div>
              <div id="batch-preview-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;max-height:200px;overflow-y:auto;"></div>
            </div>
            
            <div style="margin-top:12px;display:flex;gap:12px;">
              <div style="flex:1">
                <label>Ch·ªçn model:</label>
                <select name="model" required>
                  {% for m in models %}
                    <option value="{{m}}" {% if m == last_model %}selected{% endif %}>{{m}}</option>
                  {% endfor %}
                </select>
              </div>
              <div style="width:220px">
                <label>Pipeline:</label>
                <select name="pipeline" required>
                  {% for p in pipelines %}
                    <option value="{{p}}" {% if p == last_pipeline %}selected{% endif %}>{{p}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div style="margin-top:10px;padding:10px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;font-size:0.9em;">
              <strong>‚ö° L∆∞u √Ω Batch Mode:</strong> 
              <ul style="margin:5px 0 0 20px;padding:0;">
                <li>C√≥ th·ªÉ upload t·ªëi ƒëa 10 ·∫£nh c√πng l√∫c</li>
                <li>T·∫•t c·∫£ ·∫£nh s·∫Ω d√πng c√πng model v√† pipeline</li>
                <li>Qu√° tr√¨nh x·ª≠ l√Ω c√≥ th·ªÉ m·∫•t v√†i ph√∫t</li>
              </ul>
            </div>
            
            <div style="margin-top:14px;">
              <button type="submit" id="batch-predict-btn" class="btn" style="width: 100%;">D·ª± ƒëo√°n t·∫•t c·∫£</button>
            </div>
          </form>

          <div id="loading" style="display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px;">
            <div class="spinner"></div>
            <p style="margin-top:10px; font-size:1.2em; color:var(--tomato-700);">Xin vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
          </div>
        </div>
        
        <div style="margin-top:14px" class="card">
          <h3 style="margin-top:0">M·∫πo ch·ª•p ·∫£nh</h3>
          <ul>
            <li>√Ånh s√°ng t·ª± nhi√™n, tr√°nh b√≥ng t·ªëi v√πng l√°.</li>
            <li>Ch·ª•p to√†n b·ªô l√° ho·∫∑c ph·∫ßn c√≥ t·ªïn th∆∞∆°ng r√µ r√†ng.</li>
            <li>Kh√¥ng ch·ª•p qu√° s√°t l√†m m·∫•t b·ªëi c·∫£nh.</li>
          </ul>
        </div>
      </div>

      <aside style="width:320px">
        <div class="card">
          <h3 style="margin-top:0; text-align:center;">·∫¢nh ƒë·∫ßu v√†o</h3>
          <div id="preview-container" style="display:flex;justify-content:center;align-items:center;min-height:200px;background-color:#f9f9f9;border-radius:8px;">
            <img id="preview" class="preview" src="#" alt="Preview" style="display:none;max-width:100%;max-height:250px;border-radius:8px;"/>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">B·ªô s∆∞u t·∫≠p</h3>
          <div class="tomato-gallery">
            <img src="https://tse2.mm.bing.net/th/id/OIP.fiTPNS81lLkNK5R4ZYQYpwHaFj?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3" alt="Tomato leaf">
            <img src="https://congtydelta.com/public/upload/slide/benh-heo-vang-tren-cay-ca-chua-kimnonggoldstar-vn-2-1.jpg" alt="Tomato disease">
            <img src="https://bloganchoi.com/wp-content/uploads/2016/06/ca-chua-dep.jpg" alt="Tomato">
          </div>
        </div>
      </aside>
    </section>

{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file');
    const batchFilesInput = document.getElementById('batch-files');
    const fileNameEl = document.getElementById('file-name');
    const fileInfoEl = document.getElementById('file-info');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('preview-container');
    const removeBtn = document.getElementById('remove-file-btn');
    const fileDropArea = document.querySelector('.file-drop-area');
    
    // Batch elements
    const batchFileInfo = document.getElementById('batch-file-info');
    const batchCount = document.getElementById('batch-count');
    const batchPreviewList = document.getElementById('batch-preview-list');
    const removeBatchBtn = document.getElementById('remove-batch-btn');
    const batchDropArea = document.getElementById('batch-drop-area');
    
    let currentMode = 'single';

    // Switch between single and batch mode
    function switchMode(mode) {
        currentMode = mode;
        const singleBtn = document.getElementById('single-mode-btn');
        const batchBtn = document.getElementById('batch-mode-btn');
        const singleForm = document.getElementById('upload-form');
        const batchForm = document.getElementById('batch-form');
        
        if (mode === 'single') {
            singleBtn.classList.add('active');
            batchBtn.classList.remove('active');
            singleForm.style.display = 'block';
            batchForm.style.display = 'none';
            resetFile();
        } else {
            batchBtn.classList.add('active');
            singleBtn.classList.remove('active');
            singleForm.style.display = 'none';
            batchForm.style.display = 'block';
            resetBatchFiles();
        }
    }

    // Single file handling
    function handleFile(file) {
      if (file) {
        fileNameEl.textContent = file.name;
        fileInfoEl.style.display = 'block';
        fileDropArea.classList.add('has-file');

        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        previewContainer.style.background = 'none';
      }
    }

    function resetFile() {
        fileInput.value = '';
        fileNameEl.textContent = '';
        fileInfoEl.style.display = 'none';
        fileDropArea.classList.remove('has-file');

        preview.src = '#';
        preview.style.display = 'none';
        previewContainer.style.background = '#f9f9f9';
    }

    function onFileChange(e){
      const file = e.target.files && e.target.files.length ? e.target.files[0] : null;
      handleFile(file);
    }

    removeBtn.addEventListener('click', resetFile);

    // Batch file handling
    function onBatchFileChange(e) {
        const files = Array.from(e.target.files);
        if (files.length > 10) {
            alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 10 ·∫£nh');
            batchFilesInput.value = '';
            return;
        }
        displayBatchFiles(files);
    }

    function displayBatchFiles(files) {
        if (files.length === 0) {
            batchFileInfo.style.display = 'none';
            return;
        }
        
        batchFileInfo.style.display = 'block';
        batchCount.textContent = files.length;
        batchPreviewList.innerHTML = '';
        
        files.forEach((file, idx) => {
            const imgContainer = document.createElement('div');
            imgContainer.style.cssText = 'position:relative;aspect-ratio:1;';
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:4px;';
            img.title = file.name;
            
            imgContainer.appendChild(img);
            batchPreviewList.appendChild(imgContainer);
        });
        
        batchDropArea.classList.add('has-file');
    }

    function resetBatchFiles() {
        batchFilesInput.value = '';
        batchFileInfo.style.display = 'none';
        batchPreviewList.innerHTML = '';
        batchCount.textContent = '0';
        batchDropArea.classList.remove('has-file');
    }

    removeBatchBtn.addEventListener('click', resetBatchFiles);

    // Drag and drop for single file
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('highlight'), false);
    });
    fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('highlight'), false);
    fileDropArea.addEventListener('drop', (e) => {
        fileDropArea.classList.remove('highlight');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFile(files[0]);
        }
    }, false);

    // Drag and drop for batch files
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      batchDropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        batchDropArea.addEventListener(eventName, () => batchDropArea.classList.add('highlight'), false);
    });
    batchDropArea.addEventListener('dragleave', () => batchDropArea.classList.remove('highlight'), false);
    batchDropArea.addEventListener('drop', (e) => {
        batchDropArea.classList.remove('highlight');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 10) {
            alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 10 ·∫£nh');
            return;
        }
        batchFilesInput.files = e.dataTransfer.files;
        displayBatchFiles(files);
    }, false);

    // Form submit handling
    document.addEventListener('DOMContentLoaded', function() {
        const singleForm = document.getElementById('upload-form');
        const batchForm = document.getElementById('batch-form');
        const loading = document.getElementById('loading');
        const predictBtn = document.getElementById('predict-btn');
        const batchPredictBtn = document.getElementById('batch-predict-btn');

        singleForm.addEventListener('submit', function() {
            loading.style.display = 'flex';
            predictBtn.disabled = true;
        });

        batchForm.addEventListener('submit', function() {
            loading.style.display = 'flex';
            batchPredictBtn.disabled = true;
        });
    });
</script>
{% endblock %}
