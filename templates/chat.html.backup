{% extends "base.html" %}

{% block title %}H·ªèi ƒë√°p | Tomato AI{% endblock %}

{% block content %}
<style>
  .chat-container {
    max-width: 800px;
    margin: 18px auto 0 auto;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
  }

  #chat-window {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: #f9fafb;
    min-height: 400px;
    max-height: 60vh;
    scroll-behavior: smooth;
  }

  .message {
    display: flex;
    align-items: flex-end;
    margin-bottom: 15px;
    max-width: 85%;
    position: relative;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 0 10px;
    flex-shrink: 0;
  }

  .message-content {
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.6;
    position: relative;
  }

  /* Markdown styling */
  .message-content strong {
    font-weight: 600;
  }
  .message-content em {
    font-style: italic;
  }
  .message-content code {
    background-color: rgba(0,0,0,0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
  }
  .message-content ul, .message-content ol {
    margin: 8px 0;
    padding-left: 20px;
  }
  .message-content li {
    margin: 4px 0;
  }

  /* Timestamp */
  .message-timestamp {
    font-size: 0.75em;
    color: #8e8e93;
    margin-top: 4px;
    display: block;
  }

  /* Bot messages */
  .bot-msg {
    align-self: flex-start;
    margin-right: auto;
  }
  .bot-msg .message-content {
    background-color: #e9e9eb;
    color: #1c1c1e;
    border-bottom-left-radius: 4px;
  }
  .bot-msg .message-content code {
    background-color: rgba(0,0,0,0.15);
  }

  /* User messages */
  .user-msg {
    align-self: flex-end;
    flex-direction: row-reverse;
    margin-left: auto;
  }
  .user-msg .message-content {
    background-color: #107bedff;
    color: white;
    border-bottom-right-radius: 4px;
    text-align: right;
  }
  .user-msg .avatar {
    background-color: #107bedff;
  }

  /* Copy button */
  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255,255,255,0.8);
    border: none;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.8em;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .bot-msg:hover .copy-btn {
    opacity: 1;
  }
  .copy-btn:hover {
    background: rgba(255,255,255,1);
  }
  .copy-btn.copied {
    background: #4caf50;
    color: white;
  }

  #chat-input-area {
    display: flex;
    padding: 12px;
    gap: 8px;
    border-top: 1px solid #e0e0e0;
    background-color: #ffffffff;
  }



  .suggestion-bubbles {
    padding: 10px 20px;
    background-color: #f9fafb;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    border-bottom: 1px solid #e0e0e0;
  }
  .suggestion-bubble {
    padding: 6px 12px;
    border-radius: 16px;
    background-color: #e9e9eb;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s;
  }
  .suggestion-bubble:hover {
    background-color: #dcdfe6;
  }
  
  /* Typing indicator */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background-color: #e9e9eb;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
  }
  
  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #8e8e93;
    display: inline-block;
    animation: typing-bounce 1.4s infinite ease-in-out both;
  }
  
  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s;
  }
  
  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s;
  }
  
  @keyframes typing-bounce {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }
  
  /* Mobile optimization */
  @media (max-width: 768px) {
    .chat-container { 
      margin: 12px; 
      max-height: calc(100vh - 100px);
    }
    #chat-window {
      max-height: calc(100vh - 250px);
      padding: 15px;
    }
    .message {
      max-width: 90%;
    }
    .suggestion-bubble {
      font-size: 0.85em;
      padding: 5px 10px;
    }
    #chat-input {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
</style>

  <h1 style="margin-top:18px;">H·ªèi ƒë√°p c√°c th√¥ng tin v·ªÅ c√† chua v√† b·ªánh tr√™n l√° c√† chua</h1>

  <main style="margin-top:18px">
    <div class="chat-container">
      <div id="chat-window">
        <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
      </div>

      <div class="suggestion-bubbles">
        <div class="suggestion-bubble" onclick="askSuggestion('Tri·ªáu ch·ª©ng b·ªánh s·ªõm l√† g√¨?')">Tri·ªáu ch·ª©ng b·ªánh s·ªõm?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('C√°ch ph√≤ng ng·ª´a virus xo·∫Øn l√°?')">Ph√≤ng ng·ª´a virus xo·∫Øn l√°?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('L√° c√† chua kh·ªèe m·∫°nh tr√¥ng nh∆∞ th·∫ø n√†o?')">L√° kh·ªèe m·∫°nh?</div>
      </div>

      <div id="chat-input-area">
        <input id="chat-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi (v√≠ d·ª•: 'Tri·ªáu ch·ª©ng Tomato_Early_blight l√† g√¨?')" style="flex:1;padding:10px;border-radius:6px;border:1px solid #ddd">
        <button id="chat-send" class="btn">G·ª≠i</button>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
<script>
  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('chat-input');
  const btn = document.getElementById('chat-send');

  const BOT_AVATAR = "{{ url_for('static', filename='images/bot.png') }}";
  const USER_AVATAR = "{{ url_for('static', filename='images/avatar.jpg') }}";

  // Check if marked is loaded, otherwise use fallback
  const hasMarked = typeof marked !== 'undefined';
  if (hasMarked) {
    marked.setOptions({
      breaks: true,
      gfm: true
    });
  }

  /**
   * Simple markdown parser fallback (if marked.js fails to load)
   */
  function simpleMarkdown(text) {
    if (!text) return '';
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`(.+?)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');
  }

  /**
   * Format timestamp to HH:MM
   */
  function formatTime() {
    const now = new Date();
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  }

  /**
   * Create copy button for bot messages
   */
  function createCopyButton(text) {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.onclick = function() {
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì Copied';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    };
    return btn;
  }

  /**
  /**
   * Send message and handle response
   */
  async function send(){
    const q = input.value.trim();
    if(!q) return;
    
    // Disable input while processing
    input.disabled = true;
    btn.disabled = true;
    
    append(q,'user');
    input.value = '';
    
    // Handle greetings locally
    if (isGreeting(q)) {
      const greetingReplies = [
        'Ch√†o b·∫°n! üëã T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:\n\n- **Tri·ªáu ch·ª©ng** b·ªánh c√† chua\n- **Nguy√™n nh√¢n** v√† c√°ch ph√≤ng tr√°nh\n- **ChƒÉm s√≥c** v√† thu ho·∫°ch\n\nH√£y h·ªèi t√¥i nh√©!'
      ];
      const reply = greetingReplies[Math.floor(Math.random() * greetingReplies.length)];
      setTimeout(() => {
        append(reply, 'bot');
        updateDynamicSuggestions(['Tri·ªáu ch·ª©ng b·ªánh ch√°y s·ªõm?', 'C√°ch chƒÉm s√≥c c√† chua', 'Khi n√†o thu ho·∫°ch?']);
        input.disabled = false;
        btn.disabled = false;
        input.focus();
      }, 500);
      return;
    }

    // Show typing indicator
    const thinking = append('', 'bot', true);

    try {
      const startTime = Date.now();
      const response = await fetch('{{ url_for('api_chat') }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({q})
      });

      const data = await response.json();
      const elapsed = Date.now() - startTime;
      
      // Ensure minimum display time for typing indicator
      const minDelay = Math.max(0, 1500 - elapsed);
      await sleep(minDelay);

      // Remove typing indicator
      if (thinking) thinking.remove();

      if (!data || data.error) {
        const errorMsg = data.error === 'rate_limit' 
          ? '‚ö†Ô∏è B·∫°n ƒëang h·ªèi qu√° nhanh. Vui l√≤ng ƒë·ª£i m·ªôt ch√∫t r·ªìi th·ª≠ l·∫°i.' 
          : '‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
        append(errorMsg, 'bot');
      } else {
        const answer = data.answer || 'Xin l·ªói, t√¥i kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi. B·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m tr√™n c√°c n·ªÅn t·∫£ng uy t√≠n.';
        append(answer, 'bot');
        
        // Update dynamic suggestions based on answer
        updateDynamicSuggestions(generateSuggestions(q, answer));
      }
    } catch (error) {
      if (thinking) thinking.remove();
      append('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i sau.', 'bot');
    } finally {
      input.disabled = false;
      btn.disabled = false;
      input.focus();
    }
  }

  /**
   * Generate dynamic suggestions based on context
   */
  function generateSuggestions(question, answer) {
    const q = question.toLowerCase();
    
    // Context-aware suggestions
    if (q.includes('tri·ªáu ch·ª©ng')) {
      return ['C√°ch ph√≤ng tr√°nh?', 'Nguy√™n nh√¢n g√¢y b·ªánh?', 'B·ªánh kh√°c t∆∞∆°ng t·ª±?'];
    } else if (q.includes('ph√≤ng') || q.includes('ng·ª´a')) {
      return ['Thu·ªëc tr·ªã b·ªánh?', 'C√°ch chƒÉm s√≥c?', 'Tri·ªáu ch·ª©ng kh√°c?'];
    } else if (q.includes('b·ªánh')) {
      return ['Tri·ªáu ch·ª©ng l√† g√¨?', 'C√°ch ƒëi·ªÅu tr·ªã?', 'Ph√≤ng ng·ª´a th·∫ø n√†o?'];
    } else if (q.includes('chƒÉm s√≥c')) {
      return ['B√≥n ph√¢n nh∆∞ th·∫ø n√†o?', 'T∆∞·ªõi n∆∞·ªõc ra sao?', 'Khi n√†o thu ho·∫°ch?'];
    } else {
      // Default suggestions
      return ['Tri·ªáu ch·ª©ng b·ªánh s·ªõm?', 'Ph√≤ng ng·ª´a virus?', 'ChƒÉm s√≥c c√† chua?'];
    }
  }

  /**
   * Update suggestion bubbles dynamically
   */
  function updateDynamicSuggestions(suggestions) {
    const container = document.querySelector('.suggestion-bubbles');
    container.innerHTML = '';
    suggestions.forEach(s => {
      const bubble = document.createElement('div');
      bubble.className = 'suggestion-bubble';
      bubble.textContent = s;
      bubble.onclick = () => askSuggestion(s);
      container.appendChild(bubble);
    });   const rendered = marked.parse(msg);
        content.innerHTML = rendered;
        
        // Add copy button
        const copyBtn = createCopyButton(msg);
        content.appendChild(copyBtn);
        
        // Add timestamp
        const timestamp = document.createElement('span');
        timestamp.className = 'message-timestamp';
        timestamp.textContent = formatTime();
        content.appendChild(timestamp);
      }
    }

    el.appendChild(avatar);
    el.appendChild(content);
    chatWindow.appendChild(el);
    
    // Smooth scroll to bottom
    smoothScrollToBottom();
    return el;
  }

  /**
   * Smooth scroll to bottom of chat
   */
  function smoothScrollToBottom() {
    chatWindow.scrollTo({
      top: chatWindow.scrollHeight,
      behavior: 'smooth'
    });
  }

  async function send(){
    const q = input.value.trim();
    if(!q) return;
    append(q,'user');
    input.value = '';
    // Ph√°t hi·ªán l·ªùi ch√†o v√† tr·∫£ l·ªùi ngay v·ªõi c√¢u tr·∫£ l·ªùi c√≥ s·∫µn
    if (isGreeting(q)) {
      const greetingReplies = [
        'Ch√†o b·∫°n üëã H√£y h·ªèi t√¥i v·ªÅ tri·ªáu ch·ª©ng, nguy√™n nh√¢n, kh√°i ni·ªám ho·∫∑c ph√≤ng ng·ª´a.'
      ];
      const reply = greetingReplies[Math.floor(Math.random() * greetingReplies.length)];
      append(reply, 'bot');
      return;
    }

    // For non-greeting: show a thinking indicator and ensure it's visible for at least 2s
    const thinking = append('', 'bot', true);

    const minimumDelay = sleep(2000); // 2 seconds minimum
    const fetchPromise = fetch('{{ url_for('api_chat') }}', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({q})
    }).then(r => r.json()).catch(e => ({ error: true }));

    const [data] = await Promise.all([fetchPromise, minimumDelay]).then(results => [results[0]]).catch(() => [{ error: true }]);

    // X√≥a bi·ªÉu t∆∞·ª£ng ƒëang suy nghƒ©
    if (thinking) thinking.remove();

    if (!data || data.error) {
      append('L·ªói k·∫øt n·ªëi.', 'bot');
    } else {
      append(data.answer || 'Xin l·ªói, t√¥i kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi. B·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m tr√™n c√°c n·ªÅn t·∫£ng uy t√≠n ho·∫∑c h·ªèi √Ω ki·∫øn t·ª´ c√°c chuy√™n gia.', 'bot');
    }
  }

  function isGreeting(text) {
    if (!text) return false;
    const t = text.trim().toLowerCase();
    // C√°c l·ªùi ch√†o ph·ªï bi·∫øn ti·∫øng Vi·ªát v√† ti·∫øng Anh
    const greetings = ['ch√†o', 'xin ch√†o', 'ch√†o b·∫°n', 'ch√†o anh', 'ch√†o em', 'hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
    // Ki·ªÉm tra xem to√†n b·ªô tin nh·∫Øn c√≥ ph·∫£i l√† l·ªùi ch√†o ng·∫Øn hay b·∫Øt ƒë·∫ßu b·∫±ng l·ªùi ch√†o
    for (const g of greetings) {
      if (t === g) return true;
      if (t.startsWith(g + ' ') || t.startsWith(g + '!') || t.startsWith(g + ',')) return true;
    }
    // C≈©ng coi c√°c tin nh·∫Øn r·∫•t ng·∫Øn nh∆∞ 'hi' ho·∫∑c 'hey' l√† l·ªùi ch√†o
    if (t.length <= 4 && greetings.includes(t)) return true;
    return false;
  }

  function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

  function askSuggestion(question) {
    const input = document.getElementById('chat-input');
    input.value = question;
    send();
  }

  btn.addEventListener('click', send);
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // Initialize chat with welcome message
  window.addEventListener('DOMContentLoaded', function() {
    console.log('Chat initialized');
    setTimeout(() => {
      append('Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c th√¥ng tin v·ªÅ c√† chua. üçÖ', 'bot');
    }, 100);
  });
</script>
{% endblock %}
