{% extends "base.html" %}

{% block title %}H·ªèi ƒë√°p | Tomato AI{% endblock %}

{% block content %}
<style>
  .chat-container {
    max-width: 800px;
    margin: 18px auto 0 auto;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
  }

  #chat-window {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: #f9fafb;
    min-height: 400px;
    max-height: 60vh;
  }

  .message {
    display: flex;
    align-items: flex-end;
    margin-bottom: 15px;
    max-width: 85%;
  }

  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin: 0 10px;
    flex-shrink: 0;
  }

  .message-content {
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.5;
  }

  /* Bot messages */
  .bot-msg {
    align-self: flex-start;
    margin-right: auto;
  }
  .bot-msg .message-content {
    background-color: #e9e9eb;
    color: #1c1c1e;
    border-bottom-left-radius: 4px;
  }

  /* User messages */
  .user-msg {
    align-self: flex-end;
    flex-direction: row-reverse;
    /* push the whole message container to the right */
    margin-left: auto;
  }
  .user-msg .message-content {
    background-color: #107bedff; /* M√†u xanh d∆∞∆°ng cho tin nh·∫Øn ng∆∞·ªùi d√πng */
    color: white; /* ƒê·ªïi m√†u ch·ªØ th√†nh tr·∫Øng */
    border-bottom-right-radius: 4px;
    text-align: right; /* cƒÉn ph·∫£i n·ªôi dung tin nh·∫Øn */
  }
  .user-msg .avatar {
    background-color: #107bedff; /* A light blue background for user avatar */
  }

  #chat-input-area {
    display: flex;
    padding: 12px;
    border-top: 1px solid #e0e0e0;
    background-color: #ffffffff;
  }



  .suggestion-bubbles {
    padding: 10px 20px;
    background-color: #f9fafb;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    border-bottom: 1px solid #e0e0e0;
  }
  .suggestion-bubble {
    padding: 6px 12px;
    border-radius: 16px;
    background-color: #e9e9eb;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s;
  }
  .suggestion-bubble:hover {
    background-color: #dcdfe6;
  }
  
  /* Typing indicator */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background-color: #e9e9eb;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
  }
  
  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #8e8e93;
    display: inline-block;
    animation: typing-bounce 1.4s infinite ease-in-out both;
  }
  
  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s;
  }
  
  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s;
  }
  
  @keyframes typing-bounce {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }
  
  @media (max-width: 640px) {
    .chat-container { margin: 12px; }
    .btn-export { padding: 7px 10px; font-size: 0.9em; }
  }
</style>

  <h1 style="margin-top:18px;">H·ªèi ƒë√°p c√°c th√¥ng tin v·ªÅ c√† chua v√† b·ªánh tr√™n l√° c√† chua</h1>

  <main style="margin-top:18px">
    <div class="chat-container">
      <div id="chat-window">
        <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
      </div>

      <div class="suggestion-bubbles">
        <div class="suggestion-bubble" onclick="askSuggestion('Tri·ªáu ch·ª©ng b·ªánh s·ªõm l√† g√¨?')">Tri·ªáu ch·ª©ng b·ªánh s·ªõm?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('C√°ch ph√≤ng ng·ª´a virus xo·∫Øn l√°?')">Ph√≤ng ng·ª´a virus xo·∫Øn l√°?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('L√° c√† chua kh·ªèe m·∫°nh tr√¥ng nh∆∞ th·∫ø n√†o?')">L√° kh·ªèe m·∫°nh?</div>
      </div>

      <div id="chat-input-area">
        <input id="chat-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi (v√≠ d·ª•: 'Tri·ªáu ch·ª©ng Tomato_Early_blight l√† g√¨?')" style="flex:1;padding:10px;border-radius:6px;border:1px solid #ddd">
        <button id="chat-send" class="btn">G·ª≠i</button>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
<script>
  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('chat-input');
  const btn = document.getElementById('chat-send');

  const BOT_AVATAR = "{{ url_for('static', filename='images/bot.png') }}";
  const USER_AVATAR = "{{ url_for('static', filename='images/avatar.jpg') }}";

  function append(msg, who='user', isTyping=false){
    const el = document.createElement('div');
    el.classList.add('message', `${who}-msg`);

    const avatar = document.createElement('img');
    avatar.className = 'avatar';

    const content = document.createElement('div');
    content.className = 'message-content';

    if(who==='user'){
      avatar.src = USER_AVATAR;
      content.textContent = msg;
    } else {
      avatar.src = BOT_AVATAR;
      if(isTyping) {
        // T·∫°o typing indicator v·ªõi 3 d·∫•u ch·∫•m nh·∫•p nh√°y
        content.className = 'typing-indicator';
        for(let i = 0; i < 3; i++) {
          const dot = document.createElement('span');
          content.appendChild(dot);
        }
      } else {
        // S·ª≠ d·ª•ng textContent ƒë·ªÉ tr√°nh XSS t·ª´ n·ªôi dung tr·∫£ v·ªÅ. N·∫øu mu·ªën cho ph√©p
        // m·ªôt l∆∞·ª£ng HTML an to√†n, h√£y x·ª≠ l√Ω / sanitize ph√≠a server ho·∫∑c d√πng th∆∞ vi·ªán
        // nh∆∞ DOMPurify ph√≠a client.
        content.textContent = msg;
      }
    }

    el.appendChild(avatar);
    el.appendChild(content);
    chatWindow.appendChild(el);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return el;
  }

  async function send(){
    const q = input.value.trim();
    if(!q) return;
    append(q,'user');
    input.value = '';
    // Ph√°t hi·ªán l·ªùi ch√†o v√† tr·∫£ l·ªùi ngay v·ªõi c√¢u tr·∫£ l·ªùi c√≥ s·∫µn
    if (isGreeting(q)) {
      const greetingReplies = [
        'Ch√†o b·∫°n üëã H√£y h·ªèi t√¥i v·ªÅ tri·ªáu ch·ª©ng, nguy√™n nh√¢n, kh√°i ni·ªám ho·∫∑c ph√≤ng ng·ª´a.'
      ];
      const reply = greetingReplies[Math.floor(Math.random() * greetingReplies.length)];
      append(reply, 'bot');
      return;
    }

    // For non-greeting: show a thinking indicator and ensure it's visible for at least 2s
    const thinking = append('', 'bot', true);

    const minimumDelay = sleep(2000); // 2 seconds minimum
    const fetchPromise = fetch('{{ url_for('api_chat') }}', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({q})
    }).then(r => r.json()).catch(e => ({ error: true }));

    const [data] = await Promise.all([fetchPromise, minimumDelay]).then(results => [results[0]]).catch(() => [{ error: true }]);

    // X√≥a bi·ªÉu t∆∞·ª£ng ƒëang suy nghƒ©
    if (thinking) thinking.remove();

    if (!data || data.error) {
      append('L·ªói k·∫øt n·ªëi.', 'bot');
    } else {
      append(data.answer || 'Xin l·ªói, t√¥i kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi. B·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m tr√™n c√°c n·ªÅn t·∫£ng uy t√≠n ho·∫∑c h·ªèi √Ω ki·∫øn t·ª´ c√°c chuy√™n gia.', 'bot');
    }
  }

  function isGreeting(text) {
    if (!text) return false;
    const t = text.trim().toLowerCase();
    // C√°c l·ªùi ch√†o ph·ªï bi·∫øn ti·∫øng Vi·ªát v√† ti·∫øng Anh
    const greetings = ['ch√†o', 'xin ch√†o', 'ch√†o b·∫°n', 'ch√†o anh', 'ch√†o em', 'hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
    // Ki·ªÉm tra xem to√†n b·ªô tin nh·∫Øn c√≥ ph·∫£i l√† l·ªùi ch√†o ng·∫Øn hay b·∫Øt ƒë·∫ßu b·∫±ng l·ªùi ch√†o
    for (const g of greetings) {
      if (t === g) return true;
      if (t.startsWith(g + ' ') || t.startsWith(g + '!') || t.startsWith(g + ',')) return true;
    }
    // C≈©ng coi c√°c tin nh·∫Øn r·∫•t ng·∫Øn nh∆∞ 'hi' ho·∫∑c 'hey' l√† l·ªùi ch√†o
    if (t.length <= 4 && greetings.includes(t)) return true;
    return false;
  }

  function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

  function askSuggestion(question) {
    const input = document.getElementById('chat-input');
    input.value = question;
    send();
  }

  btn.addEventListener('click', send);
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // Th√™m tin nh·∫Øn ch√†o m·ª´ng ban ƒë·∫ßu
  document.addEventListener('DOMContentLoaded', function() {
    append('Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c th√¥ng tin v·ªÅ c√† chua.', 'bot');
  });
</script>
{% endblock %}
