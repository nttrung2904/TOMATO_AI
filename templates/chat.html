{% extends "base.html" %}

{% block title %}H·ªèi ƒë√°p | Tomato AI{% endblock %}

{% block content %}
<style>
  .chat-container {
    max-width: 800px;
    margin: 18px auto 0 auto;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
  }

  #chat-window {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: #f9fafb;
    min-height: 400px;
    max-height: 60vh;
    scroll-behavior: smooth;
  }

  .message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
    max-width: 70%;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .content {
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.6;
    position: relative;
    word-wrap: break-word;
  }

  /* Markdown styling */
  .content strong {
    font-weight: 600;
  }
  .content em {
    font-style: italic;
  }
  .content code {
    background-color: rgba(0,0,0,0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
  }
  .content ul, .content ol {
    margin: 8px 0;
    padding-left: 20px;
  }
  .content li {
    margin: 4px 0;
  }

  /* Timestamp */
  .message-timestamp {
    font-size: 0.75em;
    color: #8e8e93;
    margin-top: 4px;
    display: block;
  }

  /* Bot messages - left side, default color */
  .message.bot {
    align-self: flex-start;
  }
  .message.bot .content {
    background-color: #e9e9eb;
    color: #1c1c1e;
    border-bottom-left-radius: 4px;
  }

  /* User messages - right side, blue color */
  .message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
    margin-left: auto;
  }
  .message.user .avatar {
    margin-left: 10px;
    margin-right: 0;
  }
  .message.user .content {
    background-color: #007aff;
    color: white;
    border-bottom-right-radius: 4px;
  }

  /* Copy button */
  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255,255,255,0.9);
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 0.8em;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .message.bot:hover .copy-btn {
    opacity: 1;
  }
  .copy-btn:hover {
    background: rgba(255,255,255,1);
  }
  .copy-btn.copied {
    background: #4caf50;
    color: white;
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 15px 20px;
  }
  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #8e8e93;
    margin: 0 3px;
    animation: typingBounce 1.4s infinite;
  }
  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes typingBounce {
    0%, 60%, 100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-10px);
    }
  }

  #chat-input-area {
    display: flex;
    padding: 12px;
    gap: 8px;
    border-top: 1px solid #e0e0e0;
    background-color: #ffffffff;
  }

  /* Voice and action buttons */
  .voice-btn, .speaker-btn {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
  }
  
  .voice-btn:hover, .speaker-btn:hover {
    background-color: #f0f0f0;
    border-color: #007aff;
  }
  
  .voice-btn.recording {
    background-color: #ff3b30;
    border-color: #ff3b30;
    color: white;
    animation: pulse 1.5s infinite;
  }
  
  .speaker-btn.speaking {
    background-color: #34c759;
    border-color: #34c759;
    color: white;
  }
  
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.8;
    }
  }

  .suggestion-bubbles {
    padding: 10px 20px;
    background-color: #f9fafb;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    border-bottom: 1px solid #e0e0e0;
  }
  .suggestion-bubble {
    padding: 6px 12px;
    border-radius: 16px;
    background-color: #e9e9eb;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.2s;
  }
  .suggestion-bubble:hover {
    background-color: #dcdfe6;
  }
  
  /* Typing indicator */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background-color: #e9e9eb;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
  }
  
  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #8e8e93;
    display: inline-block;
    animation: typing-bounce 1.4s infinite ease-in-out both;
  }
  
  .typing-indicator span:nth-child(1) {
    animation-delay: -0.32s;
  }
  
  .typing-indicator span:nth-child(2) {
    animation-delay: -0.16s;
  }
  
  @keyframes typing-bounce {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }
  
  /* Mobile optimization */
  @media (max-width: 768px) {
    .chat-container { 
      margin: 12px; 
      max-height: calc(100vh - 100px);
    }
    #chat-window {
      max-height: calc(100vh - 250px);
      padding: 15px;
    }
    .message {
      max-width: 90%;
    }
    .suggestion-bubble {
      font-size: 0.85em;
      padding: 5px 10px;
    }
    #chat-input {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
</style>

  <h1 style="margin-top:18px;">H·ªèi ƒë√°p c√°c th√¥ng tin v·ªÅ c√† chua v√† b·ªánh tr√™n l√° c√† chua</h1>

  <main style="margin-top:18px">
    <div class="chat-container">
      <div id="chat-window">
        <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
      </div>

      <div class="suggestion-bubbles" id="suggestion-bubbles">
        <div class="suggestion-bubble" onclick="askSuggestion('Tri·ªáu ch·ª©ng b·ªánh s·ªõm l√† g√¨?')">Tri·ªáu ch·ª©ng b·ªánh s·ªõm?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('C√°ch ph√≤ng ng·ª´a virus xo·∫Øn l√°?')">Ph√≤ng ng·ª´a virus xo·∫Øn l√°?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('L√° c√† chua kh·ªèe m·∫°nh tr√¥ng nh∆∞ th·∫ø n√†o?')">L√° kh·ªèe m·∫°nh?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('S√¢u b·ªánh th∆∞·ªùng g·∫∑p?')">S√¢u b·ªánh th∆∞·ªùng g·∫∑p?</div>
        <div class="suggestion-bubble" onclick="askSuggestion('C√°ch b√≥n ph√¢n cho c√† chua?')">C√°ch b√≥n ph√¢n?</div>
      </div>

      <div id="chat-input-area">
        <button id="voice-btn" class="voice-btn" title="Nh·∫•n ƒë·ªÉ n√≥i (ho·∫∑c gi·ªØ ph√≠m Space)">üé§</button>
        <input id="chat-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c nh·∫•n üé§ ƒë·ªÉ n√≥i..." style="flex:1;padding:10px;border-radius:6px;border:1px solid #ddd">
        <button id="speaker-btn" class="speaker-btn" title="B·∫≠t/t·∫Øt ƒë·ªçc c√¢u tr·∫£ l·ªùi">üîä</button>
        <button id="chat-send" class="btn">G·ª≠i</button>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
<script>
  const chatWindow = document.getElementById('chat-window');
  const input = document.getElementById('chat-input');
  const btn = document.getElementById('chat-send');
  const voiceBtn = document.getElementById('voice-btn');
  const speakerBtn = document.getElementById('speaker-btn');

  const BOT_AVATAR = "{{ url_for('static', filename='images/bot.png') }}";
  const USER_AVATAR = "{{ url_for('static', filename='images/avatar.jpg') }}";

  // Voice recognition setup
  let recognition = null;
  let isRecording = false;
  let autoSpeakEnabled = localStorage.getItem('autoSpeak') !== 'false'; // Default: enabled
  let speechSynthesis = window.speechSynthesis;
  let currentUtterance = null;

  // Initialize speech recognition
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'vi-VN';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      input.value = transcript;
      stopRecording();
    };

    recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      stopRecording();
      if (event.error === 'no-speech') {
        showToast('Kh√¥ng nghe th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.');
      } else if (event.error === 'not-allowed') {
        showToast('Vui l√≤ng cho ph√©p truy c·∫≠p microphone.');
      }
    };

    recognition.onend = () => {
      stopRecording();
    };
  } else {
    voiceBtn.style.display = 'none';
    console.warn('Speech recognition not supported');
  }

  // Update speaker button appearance
  function updateSpeakerButton() {
    if (autoSpeakEnabled) {
      speakerBtn.textContent = 'üîä';
      speakerBtn.title = 'ƒêang b·∫≠t ƒë·ªçc t·ª± ƒë·ªông (nh·∫•n ƒë·ªÉ t·∫Øt)';
      speakerBtn.classList.add('speaking');
    } else {
      speakerBtn.textContent = 'üîá';
      speakerBtn.title = 'ƒêang t·∫Øt ƒë·ªçc t·ª± ƒë·ªông (nh·∫•n ƒë·ªÉ b·∫≠t)';
      speakerBtn.classList.remove('speaking');
    }
  }
  updateSpeakerButton();

  // Toggle auto-speak
  speakerBtn.addEventListener('click', () => {
    autoSpeakEnabled = !autoSpeakEnabled;
    localStorage.setItem('autoSpeak', autoSpeakEnabled);
    updateSpeakerButton();
    
    // Stop current speech if disabling
    if (!autoSpeakEnabled && currentUtterance) {
      speechSynthesis.cancel();
    }
    
    showToast(autoSpeakEnabled ? '‚úì ƒê√£ b·∫≠t ƒë·ªçc t·ª± ƒë·ªông' : '‚úó ƒê√£ t·∫Øt ƒë·ªçc t·ª± ƒë·ªông');
  });

  // Start/stop recording
  function startRecording() {
    if (!recognition) return;
    
    isRecording = true;
    voiceBtn.classList.add('recording');
    voiceBtn.textContent = '‚èπÔ∏è';
    voiceBtn.title = 'ƒêang nghe... (nh·∫•n ƒë·ªÉ d·ª´ng)';
    
    try {
      recognition.start();
      showToast('ƒêang nghe... H√£y n√≥i c√¢u h·ªèi c·ªßa b·∫°n');
    } catch (e) {
      console.error('Error starting recognition:', e);
      stopRecording();
    }
  }

  function stopRecording() {
    if (!recognition || !isRecording) return;
    
    isRecording = false;
    voiceBtn.classList.remove('recording');
    voiceBtn.textContent = 'üé§';
    voiceBtn.title = 'Nh·∫•n ƒë·ªÉ n√≥i (ho·∫∑c gi·ªØ ph√≠m Space)';
    
    try {
      recognition.stop();
    } catch (e) {
      console.error('Error stopping recognition:', e);
    }
  }

  voiceBtn.addEventListener('click', () => {
    if (isRecording) {
      stopRecording();
    } else {
      startRecording();
    }
  });

  // Keyboard shortcut: Hold Space to record
  let spacePressed = false;
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !spacePressed && document.activeElement !== input && !isRecording) {
      spacePressed = true;
      e.preventDefault();
      startRecording();
    }
  });

  document.addEventListener('keyup', (e) => {
    if (e.code === 'Space' && spacePressed) {
      spacePressed = false;
      stopRecording();
    }
  });

  // Text-to-speech function
  function speakText(text) {
    if (!autoSpeakEnabled || !speechSynthesis) return;
    
    // Cancel any ongoing speech
    speechSynthesis.cancel();
    
    // Remove markdown and special characters for cleaner speech
    const cleanText = text
      .replace(/\*\*/g, '')
      .replace(/\*/g, '')
      .replace(/#{1,6}\s/g, '')
      .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
      .replace(/`/g, '')
      .replace(/\n+/g, '. ');
    
    currentUtterance = new SpeechSynthesisUtterance(cleanText);
    currentUtterance.lang = 'vi-VN';
    currentUtterance.rate = 0.9;
    currentUtterance.pitch = 1;
    
    // Find Vietnamese voice if available
    const voices = speechSynthesis.getVoices();
    const viVoice = voices.find(voice => voice.lang.startsWith('vi'));
    if (viVoice) {
      currentUtterance.voice = viVoice;
    }
    
    speechSynthesis.speak(currentUtterance);
  }

  // Show toast notification
  function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // Check if marked is loaded, otherwise use fallback
  const hasMarked = typeof marked !== 'undefined';
  if (hasMarked) {
    marked.setOptions({
      breaks: true,
      gfm: true
    });
  }

  /**
   * Simple markdown parser fallback (if marked.js fails to load)
   */
  function simpleMarkdown(text) {
    if (!text) return '';
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`(.+?)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');
  }

  /**
   * Format timestamp to HH:MM
   */
  function formatTime() {
    const now = new Date();
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  }

  /**
   * Create copy button for bot messages
   */
  function createCopyButton(text) {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.onclick = function() {
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì Copied';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    };
    return btn;
  }

  /**
   * Append message to chat window
   * @param {string} msg - Message text
   * @param {string} who - 'user' or 'bot'
   * @param {boolean} isTyping - Show typing indicator
   * @returns {HTMLElement} Message element
   */
  function append(msg, who, isTyping = false) {
    const el = document.createElement('div');
    el.className = 'message ' + who;

    const avatar = document.createElement('img');
    avatar.className = 'avatar';
    const content = document.createElement('div');
    content.className = 'content';

    if(who === 'user') {
      avatar.src = USER_AVATAR;
      content.textContent = msg;
    } else {
      avatar.src = BOT_AVATAR;
      if(isTyping) {
        // Typing indicator
        content.className = 'typing-indicator';
        for(let i = 0; i < 3; i++) {
          const dot = document.createElement('span');
          content.appendChild(dot);
        }
      } else {
        // Render markdown for bot messages (with fallback)
        try {
          if (hasMarked && typeof marked !== 'undefined' && marked.parse) {
            content.innerHTML = marked.parse(msg);
          } else {
            content.innerHTML = simpleMarkdown(msg);
          }
        } catch (e) {
          console.error('Markdown rendering failed:', e);
          content.innerHTML = simpleMarkdown(msg);
        }
        
        // Add copy button
        const copyBtn = createCopyButton(msg);
        content.appendChild(copyBtn);
        
        // Add timestamp
        const timestamp = document.createElement('span');
        timestamp.className = 'message-timestamp';
        timestamp.textContent = formatTime();
        content.appendChild(timestamp);
      }
    }

    el.appendChild(avatar);
    el.appendChild(content);
    chatWindow.appendChild(el);
    
    // Smooth scroll to bottom
    smoothScrollToBottom();
    return el;
  }

  /**
   * Smooth scroll to bottom of chat
   */
  function smoothScrollToBottom() {
    chatWindow.scrollTo({
      top: chatWindow.scrollHeight,
      behavior: 'smooth'
    });
  }

  /**
   * Send message and handle response
   */
  async function send(){
    const q = input.value.trim();
    if(!q) return;
    
    // Disable input while processing
    input.disabled = true;
    btn.disabled = true;
    
    append(q,'user');
    input.value = '';
    
    // Handle greetings locally
    if (isGreeting(q)) {
      const greetingReplies = [
        'Ch√†o b·∫°n! üëã T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:\n\n- **Tri·ªáu ch·ª©ng** b·ªánh c√† chua\n- **Nguy√™n nh√¢n** v√† c√°ch ph√≤ng tr√°nh\n- **ChƒÉm s√≥c** v√† thu ho·∫°ch\n\nH√£y h·ªèi t√¥i nh√©!'
      ];
      const reply = greetingReplies[Math.floor(Math.random() * greetingReplies.length)];
      setTimeout(() => {
        append(reply, 'bot');
        updateDynamicSuggestions(['Tri·ªáu ch·ª©ng b·ªánh ch√°y s·ªõm?', 'C√°ch chƒÉm s√≥c c√† chua', 'Khi n√†o thu ho·∫°ch?']);
        input.disabled = false;
        btn.disabled = false;
        input.focus();
      }, 500);
      return;
    }

    // Show typing indicator
    const thinking = append('', 'bot', true);

    try {
      const startTime = Date.now();
      const response = await fetch('{{ url_for('api_chat') }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({q})
      });

      const data = await response.json();
      const elapsed = Date.now() - startTime;
      
      // Ensure minimum display time for typing indicator
      const minDelay = Math.max(0, 1500 - elapsed);
      await sleep(minDelay);

      // Remove typing indicator
      if (thinking) thinking.remove();

      if (!data || data.error) {
        const errorMsg = data.error === 'rate_limit' 
          ? '‚ö†Ô∏è B·∫°n ƒëang h·ªèi qu√° nhanh. Vui l√≤ng ƒë·ª£i m·ªôt ch√∫t r·ªìi th·ª≠ l·∫°i.' 
          : '‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
        append(errorMsg, 'bot');
      } else {
        const answer = data.answer || 'Xin l·ªói, t√¥i kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi. B·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m tr√™n c√°c n·ªÅn t·∫£ng uy t√≠n.';
        append(answer, 'bot');
        
        // Speak the answer if auto-speak is enabled
        speakText(answer);
        
        // Update dynamic suggestions based on answer
        updateDynamicSuggestions(generateSuggestions(q, answer));
      }
    } catch (error) {
      if (thinking) thinking.remove();
      append('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i sau.', 'bot');
    } finally {
      input.disabled = false;
      btn.disabled = false;
      input.focus();
    }
  }

  /**
   * Generate dynamic suggestions based on context
   */
  function generateSuggestions(question, answer) {
    const q = question.toLowerCase();
    const a = answer.toLowerCase();
    
    // Detect disease mentions in answer
    const diseases = ['early_blight', 'late_blight', 'septoria', 'yellow_curl', 'mosaic', 'target_spot', 
                      'b·ªánh s·ªõm', 'b·ªánh mu·ªôn', 'ƒë·ªëm l√°', 'xo·∫Øn l√°', 'kh·∫£m l√°'];
    const mentionedDisease = diseases.find(d => a.includes(d));
    
    // Context-aware suggestions
    if (q.includes('tri·ªáu ch·ª©ng') || q.includes('d·∫•u hi·ªáu')) {
      return [
        'Nguy√™n nh√¢n g√¢y b·ªánh n√†y?',
        'C√°ch ƒëi·ªÅu tr·ªã v√† ph√≤ng ng·ª´a?',
        'B·ªánh kh√°c t∆∞∆°ng t·ª±?',
        'Thu·ªëc tr·ªã b·ªánh n√†o hi·ªáu qu·∫£?'
      ];
    } else if (q.includes('ph√≤ng') || q.includes('ng·ª´a') || q.includes('tr√°nh')) {
      return [
        'Thu·ªëc tr·ªã b·ªánh g√¨?',
        'C√°ch chƒÉm s√≥c ƒë√∫ng?',
        'Tri·ªáu ch·ª©ng b·ªánh n√†y?',
        'Khi n√†o c·∫ßn x·ª≠ l√Ω?'
      ];
    } else if (q.includes('thu·ªëc') || q.includes('ƒëi·ªÅu tr·ªã') || q.includes('x·ª≠ l√Ω')) {
      return [
        'Li·ªÅu l∆∞·ª£ng phun bao nhi√™u?',
        'C√°ch ph√≤ng ng·ª´a l√¢u d√†i?',
        'S·ª≠ d·ª•ng thu·ªëc bao l√¢u?',
        'C√≥ bi·ªán ph√°p t·ª± nhi√™n kh√¥ng?'
      ];
    } else if (q.includes('b·ªánh')) {
      if (mentionedDisease) {
        return [
          'Tri·ªáu ch·ª©ng chi ti·∫øt?',
          'C√°ch ƒëi·ªÅu tr·ªã hi·ªáu qu·∫£?',
          'Ph√≤ng ng·ª´a th·∫ø n√†o?',
          'So s√°nh v·ªõi b·ªánh kh√°c?'
        ];
      }
      return [
        'C√°c lo·∫°i b·ªánh th∆∞·ªùng g·∫∑p?',
        'Tri·ªáu ch·ª©ng t·ª´ng b·ªánh?',
        'C√°ch ph√¢n bi·ªát c√°c b·ªánh?',
        'B·ªánh n√†o nguy hi·ªÉm nh·∫•t?'
      ];
    } else if (q.includes('chƒÉm s√≥c') || q.includes('tr·ªìng') || q.includes('thu ho·∫°ch')) {
      return [
        'B√≥n ph√¢n nh∆∞ th·∫ø n√†o?',
        'T∆∞·ªõi n∆∞·ªõc ra sao?',
        'Khi n√†o thu ho·∫°ch?',
        'C√°ch t·ªâa c√†nh ƒë√∫ng?'
      ];
    } else if (q.includes('ph√¢n') || q.includes('dinh d∆∞·ª°ng')) {
      return [
        'Lo·∫°i ph√¢n n√†o t·ªët?',
        'T·∫ßn su·∫•t b√≥n ph√¢n?',
        'Thi·∫øu dinh d∆∞·ª°ng nh·∫≠n bi·∫øt sao?',
        'Ph√¢n h·ªØu c∆° hay h√≥a h·ªçc?'
      ];
    } else if (q.includes('t∆∞·ªõi') || q.includes('n∆∞·ªõc')) {
      return [
        'T∆∞·ªõi bao nhi√™u l√≠t/ng√†y?',
        'Th·ªùi ƒëi·ªÉm t∆∞·ªõi t·ªët nh·∫•t?',
        'T∆∞·ªõi qu√° nhi·ªÅu c√≥ sao kh√¥ng?',
        'H·ªá th·ªëng t∆∞·ªõi nh·ªè gi·ªçt?'
      ];
    } else if (q.includes('s√¢u') || q.includes('r·ªáp') || q.includes('s√¢u b·ªánh')) {
      return [
        'C√°ch di·ªát s√¢u t·ª± nhi√™n?',
        'Thu·ªëc tr·ª´ s√¢u n√†o an to√†n?',
        'Nh·∫≠n bi·∫øt s√¢u h·∫°i?',
        'Ph√≤ng ng·ª´a s√¢u b·ªánh?'
      ];
    } else {
      // Smart default based on common topics
      return [
        'Tri·ªáu ch·ª©ng c√°c b·ªánh l√°?',
        'Ph√≤ng ng·ª´a b·ªánh hi·ªáu qu·∫£?',
        'C√°ch chƒÉm s√≥c c√† chua?',
        'Khi n√†o c·∫ßn phun thu·ªëc?',
        'L√° kh·ªèe m·∫°nh tr√¥ng ra sao?'
      ];
    }
  }

  /**
   * Update suggestion bubbles dynamically
   */
  function updateDynamicSuggestions(suggestions) {
    const container = document.getElementById('suggestion-bubbles');
    if (!container) return;
    
    // Animate out old suggestions
    container.style.opacity = '0.5';
    
    setTimeout(() => {
      container.innerHTML = '';
      
      // Limit to 5 suggestions
      const limitedSuggestions = suggestions.slice(0, 5);
      
      limitedSuggestions.forEach(s => {
        const bubble = document.createElement('div');
        bubble.className = 'suggestion-bubble';
        bubble.textContent = s;
        bubble.onclick = () => askSuggestion(s);
        container.appendChild(bubble);
      });
      
      // Animate in new suggestions
      container.style.opacity = '1';
    }, 200);
  }

  /**
   * Check if message is a greeting
   */
  function isGreeting(text) {
    if (!text) return false;
    const t = text.trim().toLowerCase();
    // C√°c l·ªùi ch√†o ph·ªï bi·∫øn ti·∫øng Vi·ªát v√† ti·∫øng Anh
    const greetings = ['ch√†o', 'xin ch√†o', 'ch√†o b·∫°n', 'ch√†o anh', 'ch√†o em', 'hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
    // Ki·ªÉm tra xem to√†n b·ªô tin nh·∫Øn c√≥ ph·∫£i l√† l·ªùi ch√†o ng·∫Øn hay b·∫Øt ƒë·∫ßu b·∫±ng l·ªùi ch√†o
    for (const g of greetings) {
      if (t === g) return true;
      if (t.startsWith(g + ' ') || t.startsWith(g + '!') || t.startsWith(g + ',')) return true;
    }
    // C≈©ng coi c√°c tin nh·∫Øn r·∫•t ng·∫Øn nh∆∞ 'hi' ho·∫∑c 'hey' l√† l·ªùi ch√†o
    if (t.length <= 4 && greetings.includes(t)) return true;
    return false;
  }

  /**
   * Sleep utility function
   */
  function sleep(ms){ 
    return new Promise(resolve => setTimeout(resolve, ms)); 
  }

  /**
   * Ask a suggestion question
   */
  function askSuggestion(question) {
    const input = document.getElementById('chat-input');
    input.value = question;
    send();
  }

  btn.addEventListener('click', send);
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

  // Initialize chat with welcome message
  window.addEventListener('DOMContentLoaded', function() {
    console.log('Chat initialized');
    setTimeout(() => {
      append('Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c th√¥ng tin v·ªÅ c√† chua. üçÖ', 'bot');
      speakText('Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c th√¥ng tin v·ªÅ c√† chua.');
    }, 100);
  });

  // Add CSS animation for toast
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
</script>
{% endblock %}
