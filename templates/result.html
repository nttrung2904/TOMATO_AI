{% extends "base.html" %}

{% block title %}K·∫øt qu·∫£ d·ª± ƒëo√°n | Tomato AI{% endblock %}

{% block content %}
  <h1 style="margin-top:18px">K·∫øt qu·∫£ d·ª± ƒëo√°n</h1>
  <style>
    /* Layout tweaks for result page */
    .result-layout{ display:flex; flex-direction:column; gap:24px; align-items:stretch; margin-top:12px; }
    .result-main{ width:100%; }
    .result-sidebar{ width:100%; flex-shrink:0; }
    .result-card{ padding:18px; }
    .prediction-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px }
    .pred-item{ display:flex; align-items:center; gap:12px; justify-content:space-between }
    .pred-left{ flex:1 }
    .progress{ background:#f1f3f5; height:10px; border-radius:8px; overflow:hidden; margin-top:6px }
    .bar{ height:100%; background:linear-gradient(90deg,#6cc070,#d9534f); border-radius:8px }
    .main-bar{ background:linear-gradient(90deg,#2d9bf0,#107bed) }
    .is-predicted-main .pred-left > div:first-child{ font-weight:700; color:#107bed }

    /* Input + info row inside sidebar: two distinct panels */
    .input-info-row{ display:flex; gap:24px; align-items:stretch }
    .input-col{ width:320px; flex:0 0 320px; padding:14px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04); border:1px solid #f0f0f0; position:relative }
    .input-col h3{ margin-bottom:8px }
    /* subtle vertical divider between the panels */
    .input-col:after{ content:""; position:absolute; top:12px; right:-12px; width:1px; height:calc(100% - 24px); background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02)); border-radius:1px }
    .info-col{ flex:1; padding:14px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04); border:1px solid #f0f0f0 }
    .input-col .img-preview{ display:block; margin:6px auto 0 auto; max-width:280px; width:100%; height:auto; border-radius:8px }

    /* Aside: separate image card (left) and info card (right) */
    .aside-columns{ display:flex; gap:20px; align-items:stretch }
    .aside-columns .image-panel{ flex:0 0 360px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #e9ecef }
    .aside-columns .image-panel h3{ margin:0 0 16px 0; font-size:1.1em; color:var(--text-primary); font-weight:600 }
    .aside-columns .image-panel img{ width:100%; height:auto; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1) }
    .aside-columns .info-panel{ flex:1; background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #e9ecef }
    .aside-columns .info-panel h3{ margin:0 0 12px 0; font-size:1.1em; display:flex; align-items:center; gap:8px; color:var(--text-primary); font-weight:600 }
    .aside-columns .disease-content{ margin-top:16px; padding:16px; background:linear-gradient(135deg, #f8f9ff 0%, #fff9f9 100%); border-radius:10px; border:1px solid #e3e8ff }
    .aside-columns .disease-content strong{ color:var(--tomato-700); font-size:1.05em }
    .aside-columns .disease-content p{ margin:10px 0; color:#495057; line-height:1.6 }
    .aside-columns .disease-content h4{ margin:16px 0 10px 0; color:#2c3e50; font-size:1em; font-weight:600 }

    /* Warning when possible-not-tomato: high-visibility red text + soft red background */
    .possible-warning{ color:#b71c1c; background:linear-gradient(180deg,#fff6f6,#fff1f1); border:1px solid #f5c2c7; padding:12px; border-radius:8px; font-weight:600 }
    .possible-warning strong{ color:inherit }

    /* Back button */
    .back-btn{ display:inline-block; margin-top:12px; color:var(--muted); text-decoration:none }
    .back-btn:hover{ text-decoration:underline }

    /* Responsive: stack input + info vertically on small screens */
    @media (max-width:980px){ 
      .input-info-row{ flex-direction:column; align-items:center }
      .input-col{ width:100%; flex:0 0 auto }
      .input-col:after{ display:none }
      .input-col .img-preview{ max-width:320px }
      .aside-columns{ flex-direction:column }
      .aside-columns .image-panel{ flex:0 0 auto; width:100% }
    }
  </style>
  
  <div class="result-layout">
    <main class="result-main">
      <div class="card result-card {% if rejected_not_tomato %}rejected{% endif %}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <img src="{{ url_for('static', filename='images/tomato.svg') }}" alt="Tomato" style="width:38px;height:38px;">
            <h1 style="margin:0;font-size:1.3em;color:var(--tomato-700);">K·∫øt qu·∫£ d·ª± ƒëo√°n</h1>
          </div>
        </div>
        <div id="meta-info" {% if show_feedback or possibly_not_tomato or rejected_not_tomato %}style="display:none;"{% endif %}>
          <div style="width:100%;margin-bottom:8px;"><strong>Model:</strong> <span style="color:#1976d2">{{ model_name }}</span></div>
          <div style="width:100%;margin-bottom:8px;"><strong>Pipeline:</strong> <span style="color:var(--leaf-600)">{{ pipeline_key }}</span></div>
        </div>
        {# possibly_not_tomato warning moved below to avoid duplicate messages #}
        {% if show_feedback %}
        <div style="margin-top:8px;" id="confirm-buttons">
          <button id="fb-not" class="btn small danger feedback-btn">ƒê√¢y kh√¥ng ph·∫£i l√° c√† chua</button>
          <button id="fb-yes" class="btn small feedback-btn">ƒê√¢y l√† l√° c√† chua</button>
          <span id="fb-msg" style="margin-left:10px;color:#1976d2;font-weight:600"></span>
        </div>
        {% endif %}
        {% if rejected_not_tomato %}
        <div class="alert danger" style="margin:14px 0 8px 0;">
          <strong>‚ö†Ô∏è ·∫¢nh n√†y ƒë∆∞·ª£c x√°c ƒë·ªãnh kh√¥ng ph·∫£i l√† l√° c√† chua.</strong>
          <div style="margin-top:10px;color:#333;">
            H·ªá th·ªëng t·ª´ ch·ªëi ƒë∆∞a ra d·ª± ƒëo√°n v√¨ ·∫£nh c√≥ ƒë·ªô t∆∞∆°ng ƒë·ªìng cao v·ªõi m·∫´u "kh√¥ng ph·∫£i l√°" ho·∫∑c kh√¥ng kh·ªõp v·ªõi ƒë·∫∑c ƒëi·ªÉm l√° c√† chua.
          </div>
          <div style="margin-top:12px;padding:10px;background:#fff3e0;border-radius:6px;">
            <strong>üí° G·ª£i √Ω:</strong>
            <ul style="margin:8px 0 0 20px;padding:0;">
              <li>ƒê·∫£m b·∫£o ·∫£nh ch·ª•p r√µ to√†n b·ªô l√° c√† chua v·ªõi √°nh s√°ng t·ªët</li>
              <li>Tr√°nh ch·ª•p c√°c ƒë·ªëi t∆∞·ª£ng kh√°c (ƒë·ªông v·∫≠t, ng∆∞·ªùi, ƒë·ªì v·∫≠t)</li>
              <li>N·∫øu ch·∫Øc ch·∫Øn ƒë√¢y l√† l√° c√† chua, click n√∫t "ƒê√¢y l√† l√° c√† chua" b√™n d∆∞·ªõi ƒë·ªÉ c·∫£i thi·ªán h·ªá th·ªëng</li>
            </ul>
          </div>
          {% if sim_info %}
            <details style="margin-top:10px;">
              <summary style="cursor:pointer;font-weight:600;color:#555;">üìä Chi ti·∫øt ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng (click ƒë·ªÉ xem)</summary>
              <div style="margin-top:8px;font-size:0.9rem;color:#555;padding:10px;background:#f9f9f9;border-radius:4px;">
                <div style="margin-bottom:6px;">
                  <strong style="color:#4caf50;">‚úì V·ªõi m·∫´u l√° c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.pos.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.pos.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.positive_sim|round(3) }}</strong> (ng∆∞·ª°ng t·ªëi thi·ªÉu: 0.60)
                </div>
                <div>
                  <strong style="color:#f44336;">‚úó V·ªõi m·∫´u kh√¥ng ph·∫£i c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.neg.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.neg.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.negative_sim|round(3) }}</strong> (ng∆∞·ª°ng t·ª´ ch·ªëi: 0.75)
                </div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
                  <strong>K·∫øt lu·∫≠n:</strong> ·∫¢nh b·ªã t·ª´ ch·ªëi v√¨ ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi "kh√¥ng ph·∫£i l√°" ({{ sim_info.negative_sim|round(3) }}) 
                  v∆∞·ª£t ng∆∞·ª°ng 0.75 v√† ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi l√° c√† chua ({{ sim_info.positive_sim|round(3) }}) d∆∞·ªõi 0.60.
                </div>
              </div>
            </details>
          {% endif %}
        </div>
        {% elif possibly_not_tomato %}
        <div class="alert warn possible-warning" style="margin:14px 0 8px 0;">
          <strong>‚ö†Ô∏è C·∫£nh b√°o: ·∫¢nh n√†y c√≥ th·ªÉ kh√¥ng ph·∫£i l√° c√† chua ho·∫∑c ch·∫•t l∆∞·ª£ng kh√¥ng r√µ r√†ng.</strong>
          <div style="margin-top:8px;">
            H·ªá th·ªëng ph√°t hi·ªán ƒë·ªô tin c·∫≠y th·∫•p ho·∫∑c ·∫£nh kh√¥ng kh·ªõp v·ªõi ƒë·∫∑c ƒëi·ªÉm l√° c√† chua ƒëi·ªÉn h√¨nh. K·∫øt qu·∫£ d·ª± ƒëo√°n c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c.
          </div>
          {% if sim_info %}
            <details style="margin-top:10px;">
              <summary style="cursor:pointer;font-weight:600;color:#555;">üìä Chi ti·∫øt ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng (click ƒë·ªÉ xem)</summary>
              <div style="margin-top:8px;font-size:0.9rem;color:#555;padding:10px;background:#f9f9f9;border-radius:4px;">
                <div style="margin-bottom:6px;">
                  <strong style="color:#4caf50;">‚úì V·ªõi m·∫´u l√° c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.pos.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.pos.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.positive_sim|round(3) }}</strong> (c·∫ßn ‚â• 0.60)
                </div>
                <div>
                  <strong style="color:#f44336;">‚úó V·ªõi m·∫´u kh√¥ng ph·∫£i c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.neg.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.neg.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.negative_sim|round(3) }}</strong> (c·∫ßn < 0.75)
                </div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
                  <strong>K·∫øt lu·∫≠n:</strong> ·∫¢nh c√≥ ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi l√° c√† chua ({{ sim_info.positive_sim|round(3) }}) th·∫•p h∆°n 0.60 
                  v√†/ho·∫∑c ƒë·ªô tin c·∫≠y model th·∫•p.
                </div>
              </div>
            </details>
          {% endif %}
          <div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.5);border-radius:4px;">
            <strong>üí° Khuy·∫øn ngh·ªã:</strong>
            <ul style="margin:6px 0 0 20px;padding:0;">
              <li>X√°c nh·∫≠n b√™n d∆∞·ªõi n·∫øu ƒë√¢y l√† l√° c√† chua ƒë·ªÉ c·∫£i thi·ªán h·ªá th·ªëng</li>
              <li>Ho·∫∑c th·ª≠ ch·ª•p l·∫°i v·ªõi √°nh s√°ng t·ªët h∆°n v√† g√≥c ch·ª•p r√µ r√†ng h∆°n</li>
              <li>Th·ª≠ model kh√°c ƒë·ªÉ so s√°nh k·∫øt qu·∫£ (VGG19, ResNet50, MobileNetV2, v.v.)</li>
            </ul>
          </div>
        </div>
        {% else %}
        <div style="margin:14px 0 8px 0;width:100%;">
          <span class="main-label">D·ª± ƒëo√°n ch√≠nh: {{ predicted_label }}</span>
          <span class="main-percent" style="color:#555;font-size:1.08em;">({{ (predicted_prob*100)|round(2) }}%)</span>
        </div>
        {% endif %}

        <div id="prediction-block" {% if show_feedback or possibly_not_tomato or rejected_not_tomato %}style="display:none"{% endif %}>
          <div class="prediction-list">
          {% for cname, p in probs %} 
            <div class="pred-item {% if cname == predicted_label %}is-predicted-main{% endif %}">
              <div class="pred-left">
                <div>
                  {% if cname == predicted_label %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                  {% endif %}
                  {{ cname }}
                </div>
                <div class="progress" aria-hidden="true">
                  <div class="bar {% if cname == predicted_label %}main-bar{% endif %}" style="width:{{ (p*100)|round(2) }}%">
                  </div>
                </div>
              </div>
              <div style="width:120px;text-align:right">{{ (p*100)|round(2) }}%</div>
            </div>
          {% endfor %}
          </div>
          
          <!-- Action Buttons -->
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e9ecef;">
            <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
              <a href="{{ url_for('index') }}" class="btn" style="background: #fff; color: #495057; border: 1px solid #dee2e6; display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; text-decoration: none;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                D·ª± ƒëo√°n ·∫£nh kh√°c
              </a>
              
              <div style="display: flex; gap: 12px; align-items: center;">
                {% if prediction_id %}
                <button onclick="exportPDF()" class="btn" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 18px;">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                  </svg>
                  Xu·∫•t b√°o c√°o PDF
                </button>
                {% endif %}
                
                <!-- Grad-CAM heatmap feature temporarily disabled due to model compatibility -->
                <!-- <button id="view-heatmap-btn" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; display: inline-flex; align-items: center; gap: 8px;">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                  </svg>
                  üî• Xem v√πng b·ªánh (Heatmap)
                </button> -->
                
                <a href="{{ url_for('history') }}" class="btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; text-decoration: none;">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                  </svg>
                  Xem l·ªãch s·ª≠
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <aside id="disease-aside" class="result-sidebar">
      <div class="aside-columns">
        <!-- ·∫¢nh ƒë√£ qua x·ª≠ l√Ω -->
        <div class="image-panel">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--tomato-600);">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            ·∫¢nh ƒë√£ qua x·ª≠ l√Ω
          </h3>
          <img src="{{ image_path }}" alt="·∫¢nh ƒë√£ x·ª≠ l√Ω">
        </div>
        
        <!-- Th√¥ng tin b·ªánh & Ph√≤ng ng·ª´a -->
        <div class="info-panel" {% if possibly_not_tomato and not show_feedback %}style="display:none"{% endif %}>
          <div class="collapsible" onclick="toggleCollapse('disease-body')" style="cursor:pointer;display:flex;align-items:center;gap:10px;padding-bottom:12px;border-bottom:1px solid #e9ecef;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--leaf-600);">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              <path d="M12 16v-4"></path>
              <path d="M12 8h.01"></path>
            </svg>
            <h3 style="margin:0;flex:1;font-size:1.1em;color:var(--text-primary);">Th√¥ng tin b·ªánh & Ph√≤ng ng·ª´a</h3>
          </div>
          
          <div id="disease-body" class="collapse-body open">
            <div class="disease-content">
              <strong>{{ disease_info.name }}</strong>
              <p>{{ disease_info.definition }}</p>
              <h4>C√°c bi·ªán ph√°p ph√≤ng ng·ª´a</h4>
              <ul class="prevention-list" style="margin:8px 0 0 0;padding-left:20px;">
                {% for tip in disease_info.prevention %}
                  <li style="margin-bottom:8px;line-height:1.6;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px; color: var(--leaf-600);">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    {{ tip }}
                  </li>
                {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCollapse(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle('open');
    }

    // X·ª≠ l√Ω n√∫t ph·∫£n h·ªìi
    document.addEventListener('DOMContentLoaded', function(){
      const btnNot = document.getElementById('fb-not');
      const btnYes = document.getElementById('fb-yes');
      const msg = document.getElementById('fb-msg');
      async function sendFeedback(action){
        try{
          const res = await fetch('{{ url_for('feedback') }}', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({action})
          });
          const data = await res.json();
          return data;
        }catch(e){
          return {ok:false, message:'L·ªói k·∫øt n·ªëi.'};
        }
      }

      if(btnYes) btnYes.addEventListener('click', async ()=>{
        // Ng∆∞·ªùi d√πng x√°c nh·∫≠n ·∫£nh L√Ä l√° c√† chua -> hi·ªÉn th·ªã d·ª± ƒëo√°n
        const status = await sendFeedback('confirm');
        if(status.ok){
          msg.textContent = 'C·∫£m ∆°n! Hi·ªÉn th·ªã k·∫øt qu·∫£...';
          // Show toast notification
          if(window.toast) {
            window.toast.success('C·∫£m ∆°n ph·∫£n h·ªìi c·ªßa b·∫°n! H·ªá th·ªëng s·∫Ω h·ªçc t·ª´ d·ªØ li·ªáu n√†y.');
          }
        } else {
          msg.textContent = status.message || 'ƒê√£ x√°c nh·∫≠n (kh√¥ng l∆∞u ƒë∆∞·ª£c).';
          if(window.toast) {
            window.toast.warning('ƒê√£ x√°c nh·∫≠n nh∆∞ng kh√¥ng l∆∞u ƒë∆∞·ª£c ph·∫£n h·ªìi');
          }
        }
        // Hi·ªÉn th·ªã kh·ªëi d·ª± ƒëo√°n v√† ·∫©n n√∫t x√°c nh·∫≠n
        const pb = document.getElementById('prediction-block');
        const cb = document.getElementById('confirm-buttons');
        if(pb) pb.style.display = 'block';
        if(cb) cb.style.display = 'none';
        
        // Hi·ªÉn th·ªã th√¥ng tin b·ªánh n·∫øu ƒëang b·ªã ·∫©n
        try{
          const aside = document.getElementById('disease-aside');
          if(aside) aside.style.display = 'block';
          const meta = document.getElementById('meta-info');
          if(meta) meta.style.display = 'block';
        }catch(e){}
        
        // ·∫®n c√°c c·∫£nh b√°o/th√¥ng b√°o t·ª´ ch·ªëi trong th·∫ª k·∫øt qu·∫£
        try{
          const alerts = document.querySelectorAll('.card.result-card .alert');
          alerts.forEach(a => a.style.display = 'none');
        }catch(e){}
        
        // X√≥a class "rejected" kh·ªèi th·∫ª k·∫øt qu·∫£ n·∫øu c√≥
        try{
          const card = document.querySelector('.card.result-card');
          if(card) card.classList.remove('rejected');
        }catch(e){}
        
        // Hi·ªÉn th·ªã th·∫ª th√¥ng tin n·∫øu ƒëang b·ªã ·∫©n
        try{
          const infoCard = document.querySelector('.card.info-card');
          if(infoCard) infoCard.style.display = 'block';
        }catch(e){}
        
        setTimeout(()=> msg.textContent = '', 3000);
      });

      if(btnNot) btnNot.addEventListener('click', async ()=>{
        // Ng∆∞·ªùi d√πng n√≥i KH√îNG ph·∫£i l√° c√† chua -> l∆∞u ph·∫£n h·ªìi v√† hi·ªán th√¥ng b√°o t·∫£i l·∫°i
        const status = await sendFeedback('not_tomato');
        const cb = document.getElementById('confirm-buttons');
        const card = document.querySelector('.card.result-card');
        const aside = document.getElementById('disease-aside');
        if(status.ok){
          // Show toast notification
          if(window.toast) {
            window.toast.info('C·∫£m ∆°n ph·∫£n h·ªìi! H·ªá th·ªëng ƒë√£ ghi nh·∫≠n ·∫£nh n√†y kh√¥ng ph·∫£i l√° c√† chua.');
          }
          // Thay n·ªôi dung th·∫ª b·∫±ng th√¥ng b√°o ng·∫Øn y√™u c·∫ßu ch·ªçn ·∫£nh kh√°c
          if(card){
            card.innerHTML = '<div style="padding:18px;"><h2>·∫¢nh kh√¥ng ph·∫£i l√° c√† chua</h2><p>Vui l√≤ng ch·ªçn l·∫°i ·∫£nh kh√°c (ch·ª•p r√µ h∆°n ho·∫∑c ch·ªçn ·∫£nh l√° th·ª±c s·ª±).</p><a href="{{ url_for('index') }}" class="back-btn">&#8592; T·∫£i ·∫£nh kh√°c</a></div>';
          }
          if(aside) aside.style.display = 'none';
        } else {
          // N·∫øu l∆∞u th·∫•t b·∫°i, v·∫´n hi·ªán th√¥ng b√°o nh∆∞ng c√≥ c·∫£nh b√°o
          if(card){
            card.innerHTML = '<div style="padding:18px;"><h2>·∫¢nh kh√¥ng ph·∫£i l√° c√† chua</h2><p>Vui l√≤ng ch·ªçn l·∫°i ·∫£nh kh√°c (ch·ª•p r√µ h∆°n ho·∫∑c ch·ªçn ·∫£nh l√° th·ª±c s·ª±).</p><div style="color:red;margin-top:6px;">L∆∞u feedback kh√¥ng th√†nh c√¥ng: '+(status.message||'Kh√¥ng x√°c ƒë·ªãnh')+'</div><a href="{{ url_for('index') }}" class="back-btn">&#8592; T·∫£i ·∫£nh kh√°c</a></div>';
          }
          if(aside) aside.style.display = 'none';
        }
      });
      // ƒê·∫£m b·∫£o khi trang hi·ªÉn th·ªã n√∫t x√°c nh·∫≠n (lu·ªìng c√≥-th·ªÉ-kh√¥ng-ph·∫£i-c√†-chua)
      // th·∫ª th√¥ng tin b·ªã ·∫©n v√† c·∫£nh b√°o hi·ªÉn th·ªã d∆∞·ªõi c√°c n√∫t.
      function enforcePossibleUI(){
        const cb = document.getElementById('confirm-buttons');
        if(!cb) return;
        const isVisible = cb.offsetParent !== null; // hi·ªÉn th·ªã trong layout
        const infoCard = document.querySelector('.card.info-card');
        const predBlock = document.getElementById('prediction-block');
        const mainLabel = document.querySelector('.main-label');
        const mainPercent = document.querySelector('.main-percent');
        if(isVisible){
          if(infoCard) infoCard.style.display = 'none';
          if(predBlock) predBlock.style.display = 'none';
          if(mainLabel) mainLabel.style.display = 'none';
          if(mainPercent) mainPercent.style.display = 'none';
          // Ch√®n c·∫£nh b√°o n·∫øu ch∆∞a c√≥
          if(!document.querySelector('.possible-warning')){
            const warn = document.createElement('div');
            warn.className = 'alert danger possible-warning';
            warn.style.margin = '10px 0 6px 0';
            warn.innerHTML = '<strong>C·∫£nh b√°o:</strong> ·∫¢nh c√≥ th·ªÉ kh√¥ng ph·∫£i l√† l√° c√† chua ho·∫∑c m√¥ t·∫£ kh√¥ng r√µ r√†ng; h·ªá th·ªëng s·∫Ω kh√¥ng ƒë∆∞a ra d·ª± ƒëo√°n ch·∫Øc ch·∫Øn. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ·∫£nh l√° r√µ r√†ng: ch·ª•p g·∫ßn l√°, ƒë·ªß s√°ng, n·ªÅn ƒë∆°n gi·∫£n.';
            cb.parentNode.insertBefore(warn, cb.nextSibling);
          }
        } else {
          if(infoCard) infoCard.style.display = '';
          if(predBlock) predBlock.style.display = '';
          if(mainLabel) mainLabel.style.display = '';
          if(mainPercent) mainPercent.style.display = '';
          const old = document.querySelector('.possible-warning');
          if(old) old.remove();
        }
      }

      // Ch·∫°y khi t·∫£i trang v√† khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c v·ªõi n√∫t ph·∫£n h·ªìi
      enforcePossibleUI();
      if(btnYes) btnYes.addEventListener('click', ()=>{
        const infoCard = document.querySelector('.card.info-card');
        if(infoCard) infoCard.style.display = '';
        const old = document.querySelector('.possible-warning'); if(old) old.remove();
      });
      if(btnNot) btnNot.addEventListener('click', ()=>{
        const old = document.querySelector('.possible-warning'); if(old) old.remove();
      });
      // Export PDF function
      window.exportPDF = function() {
        const predictionId = '{{ prediction_id }}';
        if (!predictionId) {
          if (window.toast) {
            window.toast.error('Kh√¥ng th·ªÉ xu·∫•t b√°o c√°o: Thi·∫øu ID d·ª± ƒëo√°n');
          } else {
            alert('Kh√¥ng th·ªÉ xu·∫•t b√°o c√°o');
          }
          return;
        }
        
        // Show loading toast
        if (window.toast) {
          window.toast.info('ƒêang t·∫°o b√°o c√°o PDF...', 3000);
        }
        
        // Navigate to export URL
        window.location.href = `/export/${predictionId}`;
        
        // Show success after delay
        setTimeout(() => {
          if (window.toast) {
            window.toast.success('B√°o c√°o PDF ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng');
          }
        }, 1000);
      };

      // Heatmap Viewer - Disabled
      // const heatmapBtn = document.getElementById('view-heatmap-btn');
      // if (heatmapBtn) {
      //   heatmapBtn.addEventListener('click', async function() {
      //     // Show loading
      //     const originalText = heatmapBtn.innerHTML;
      //     heatmapBtn.disabled = true;
      //     heatmapBtn.innerHTML = '<span>‚è≥ ƒêang t·∫°o heatmap...</span>';

      //     try {
      //       // Send image path directly instead of fetching
      //       const formData = new FormData();
      //       formData.append('image_path', '{{ image_path }}');
      //       formData.append('model', '{{ model_name }}');
      //       formData.append('pipeline', '{{ pipeline_key }}');

      //       // Call Grad-CAM API
      //       const response = await fetch('/api/gradcam', {
      //         method: 'POST',
      //         body: formData
      //       });

      //       const data = await response.json();

      //       if (data.ok) {
      //         // Show heatmap in modal
      //         showHeatmapModal(data.heatmap_image, data.prediction);
      //       } else {
      //         if (window.toast) {
      //           window.toast.error('Kh√¥ng th·ªÉ t·∫°o heatmap: ' + data.error);
      //         } else {
                alert('L·ªói: ' + data.error);
              }
            }
          } catch (error) {
            console.error('Error generating heatmap:', error);
            if (window.toast) {
              window.toast.error('L·ªói k·∫øt n·ªëi khi t·∫°o heatmap');
            } else {
              alert('L·ªói k·∫øt n·ªëi');
            }
          } finally {
            heatmapBtn.disabled = false;
            heatmapBtn.innerHTML = originalText;
          }
        });
      }

      function showHeatmapModal(heatmapImage, prediction) {
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'heatmap-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.85);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.3s;
        `;

        modal.innerHTML = `
          <div style="background: white; border-radius: 16px; max-width: 90%; max-height: 90%; overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
              <h2 style="margin: 0; color: #333;">üî• Disease Localization Heatmap</h2>
              <button onclick="this.closest('#heatmap-modal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="padding: 20px;">
              <div style="text-align: center;">
                <img src="${heatmapImage}" alt="Heatmap" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              </div>
              <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; color: #333;">Prediction Details:</h3>
                <p style="margin: 5px 0;"><strong>Class:</strong> ${prediction.class}</p>
                <p style="margin: 5px 0;"><strong>Confidence:</strong> ${(prediction.confidence * 100).toFixed(2)}%</p>
                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                  üî¥ <strong>Red areas</strong> indicate regions where the model detected disease symptoms<br>
                  üîµ <strong>Blue areas</strong> indicate healthy regions
                </p>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Close on backdrop click
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // Close on ESC key
        const escHandler = function(e) {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
      }
    });

    // Add fadeIn animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
