{% extends "base.html" %}

{% block title %}K·∫øt qu·∫£ d·ª± ƒëo√°n | Tomato AI{% endblock %}

{% block content %}
  <h1 style="margin-top:18px">K·∫øt qu·∫£ d·ª± ƒëo√°n</h1>
  <style>
    /* Layout tweaks for result page */
    .result-layout{ display:flex; flex-direction:column; gap:24px; align-items:stretch; margin-top:12px; }
    .result-main{ width:100%; }
    .result-sidebar{ width:100%; flex-shrink:0; }
    .result-card{ padding:18px; }
    .prediction-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px }
    .pred-item{ display:flex; align-items:center; gap:12px; justify-content:space-between }
    .pred-left{ flex:1 }
    .progress{ background:#f1f3f5; height:10px; border-radius:8px; overflow:hidden; margin-top:6px }
    .bar{ height:100%; background:linear-gradient(90deg,#6cc070,#d9534f); border-radius:8px }
    .main-bar{ background:linear-gradient(90deg,#2d9bf0,#107bed) }
    .is-predicted-main .pred-left > div:first-child{ font-weight:700; color:#107bed }

    /* Input + info row inside sidebar: two distinct panels */
    .input-info-row{ display:flex; gap:24px; align-items:stretch }
    .input-col{ width:320px; flex:0 0 320px; padding:14px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04); border:1px solid #f0f0f0; position:relative }
    .input-col h3{ margin-bottom:8px }
    /* subtle vertical divider between the panels */
    .input-col:after{ content:""; position:absolute; top:12px; right:-12px; width:1px; height:calc(100% - 24px); background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02)); border-radius:1px }
    .info-col{ flex:1; padding:14px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04); border:1px solid #f0f0f0 }
    .input-col .img-preview{ display:block; margin:6px auto 0 auto; max-width:280px; width:100%; height:auto; border-radius:8px }

    /* Aside: separate image card (left) and info card (right) */
    .aside-columns{ display:flex; gap:18px; align-items:flex-start }
    .aside-columns .input-card{ flex:0 0 320px }
    .aside-columns .info-card{ flex:1 }

    /* Warning when possible-not-tomato: high-visibility red text + soft red background */
    .possible-warning{ color:#b71c1c; background:linear-gradient(180deg,#fff6f6,#fff1f1); border:1px solid #f5c2c7; padding:12px; border-radius:8px; font-weight:600 }
    .possible-warning strong{ color:inherit }

    /* Back button */
    .back-btn{ display:inline-block; margin-top:12px; color:var(--muted); text-decoration:none }
    .back-btn:hover{ text-decoration:underline }

    /* Responsive: stack input + info vertically on small screens */
    @media (max-width:980px){ 
      .input-info-row{ flex-direction:column; align-items:center }
      .input-col{ width:100%; flex:0 0 auto }
      .input-col:after{ display:none }
      .input-col .img-preview{ max-width:320px }
    }
  </style>
  
  <div class="result-layout">
    <main class="result-main">
      <div class="card result-card {% if rejected_not_tomato %}rejected{% endif %}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <img src="{{ url_for('static', filename='images/tomato.svg') }}" alt="Tomato" style="width:38px;height:38px;">
            <h1 style="margin:0;font-size:1.3em;color:var(--tomato-700);">K·∫øt qu·∫£ d·ª± ƒëo√°n</h1>
          </div>
        </div>
        <div id="meta-info" {% if show_feedback or possibly_not_tomato or rejected_not_tomato %}style="display:none;"{% endif %}>
          <div style="width:100%;margin-bottom:8px;"><strong>Model:</strong> <span style="color:#1976d2">{{ model_name }}</span></div>
          <div style="width:100%;margin-bottom:8px;"><strong>Pipeline:</strong> <span style="color:var(--leaf-600)">{{ pipeline_key }}</span></div>
        </div>
        {# possibly_not_tomato warning moved below to avoid duplicate messages #}
        {% if show_feedback %}
        <div style="margin-top:8px;" id="confirm-buttons">
          <button id="fb-not" class="btn small danger feedback-btn">ƒê√¢y kh√¥ng ph·∫£i l√° c√† chua</button>
          <button id="fb-yes" class="btn small feedback-btn">ƒê√¢y l√† l√° c√† chua</button>
          <span id="fb-msg" style="margin-left:10px;color:#1976d2;font-weight:600"></span>
        </div>
        {% endif %}
        {% if rejected_not_tomato %}
        <div class="alert danger" style="margin:14px 0 8px 0;">
          <strong>‚ö†Ô∏è ·∫¢nh n√†y ƒë∆∞·ª£c x√°c ƒë·ªãnh kh√¥ng ph·∫£i l√† l√° c√† chua.</strong>
          <div style="margin-top:10px;color:#333;">
            H·ªá th·ªëng t·ª´ ch·ªëi ƒë∆∞a ra d·ª± ƒëo√°n v√¨ ·∫£nh c√≥ ƒë·ªô t∆∞∆°ng ƒë·ªìng cao v·ªõi m·∫´u "kh√¥ng ph·∫£i l√°" ho·∫∑c kh√¥ng kh·ªõp v·ªõi ƒë·∫∑c ƒëi·ªÉm l√° c√† chua.
          </div>
          <div style="margin-top:12px;padding:10px;background:#fff3e0;border-radius:6px;">
            <strong>üí° G·ª£i √Ω:</strong>
            <ul style="margin:8px 0 0 20px;padding:0;">
              <li>ƒê·∫£m b·∫£o ·∫£nh ch·ª•p r√µ to√†n b·ªô l√° c√† chua v·ªõi √°nh s√°ng t·ªët</li>
              <li>Tr√°nh ch·ª•p c√°c ƒë·ªëi t∆∞·ª£ng kh√°c (ƒë·ªông v·∫≠t, ng∆∞·ªùi, ƒë·ªì v·∫≠t)</li>
              <li>N·∫øu ch·∫Øc ch·∫Øn ƒë√¢y l√† l√° c√† chua, click n√∫t "ƒê√¢y l√† l√° c√† chua" b√™n d∆∞·ªõi ƒë·ªÉ c·∫£i thi·ªán h·ªá th·ªëng</li>
            </ul>
          </div>
          {% if sim_info %}
            <details style="margin-top:10px;">
              <summary style="cursor:pointer;font-weight:600;color:#555;">üìä Chi ti·∫øt ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng (click ƒë·ªÉ xem)</summary>
              <div style="margin-top:8px;font-size:0.9rem;color:#555;padding:10px;background:#f9f9f9;border-radius:4px;">
                <div style="margin-bottom:6px;">
                  <strong style="color:#4caf50;">‚úì V·ªõi m·∫´u l√° c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.pos.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.pos.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.positive_sim|round(3) }}</strong> (ng∆∞·ª°ng t·ªëi thi·ªÉu: 0.60)
                </div>
                <div>
                  <strong style="color:#f44336;">‚úó V·ªõi m·∫´u kh√¥ng ph·∫£i c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.neg.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.neg.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.negative_sim|round(3) }}</strong> (ng∆∞·ª°ng t·ª´ ch·ªëi: 0.75)
                </div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
                  <strong>K·∫øt lu·∫≠n:</strong> ·∫¢nh b·ªã t·ª´ ch·ªëi v√¨ ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi "kh√¥ng ph·∫£i l√°" ({{ sim_info.negative_sim|round(3) }}) 
                  v∆∞·ª£t ng∆∞·ª°ng 0.75 v√† ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi l√° c√† chua ({{ sim_info.positive_sim|round(3) }}) d∆∞·ªõi 0.60.
                </div>
              </div>
            </details>
          {% endif %}
        </div>
        {% elif possibly_not_tomato %}
        <div class="alert warn possible-warning" style="margin:14px 0 8px 0;">
          <strong>‚ö†Ô∏è C·∫£nh b√°o: ·∫¢nh n√†y c√≥ th·ªÉ kh√¥ng ph·∫£i l√° c√† chua ho·∫∑c ch·∫•t l∆∞·ª£ng kh√¥ng r√µ r√†ng.</strong>
          <div style="margin-top:8px;">
            H·ªá th·ªëng ph√°t hi·ªán ƒë·ªô tin c·∫≠y th·∫•p ho·∫∑c ·∫£nh kh√¥ng kh·ªõp v·ªõi ƒë·∫∑c ƒëi·ªÉm l√° c√† chua ƒëi·ªÉn h√¨nh. K·∫øt qu·∫£ d·ª± ƒëo√°n c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c.
          </div>
          {% if sim_info %}
            <details style="margin-top:10px;">
              <summary style="cursor:pointer;font-weight:600;color:#555;">üìä Chi ti·∫øt ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng (click ƒë·ªÉ xem)</summary>
              <div style="margin-top:8px;font-size:0.9rem;color:#555;padding:10px;background:#f9f9f9;border-radius:4px;">
                <div style="margin-bottom:6px;">
                  <strong style="color:#4caf50;">‚úì V·ªõi m·∫´u l√° c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.pos.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.pos.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.positive_sim|round(3) }}</strong> (c·∫ßn ‚â• 0.60)
                </div>
                <div>
                  <strong style="color:#f44336;">‚úó V·ªõi m·∫´u kh√¥ng ph·∫£i c√† chua:</strong><br>
                  &nbsp;&nbsp;‚Üí Histogram: {{ sim_info.details.neg.hist|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí Deep features (MobileNetV2): {{ sim_info.details.neg.deep|round(3) }}<br>
                  &nbsp;&nbsp;‚Üí <strong>T·ªïng h·ª£p: {{ sim_info.negative_sim|round(3) }}</strong> (c·∫ßn < 0.75)
                </div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
                  <strong>K·∫øt lu·∫≠n:</strong> ·∫¢nh c√≥ ƒë·ªô t∆∞∆°ng ƒë·ªìng v·ªõi l√° c√† chua ({{ sim_info.positive_sim|round(3) }}) th·∫•p h∆°n 0.60 
                  v√†/ho·∫∑c ƒë·ªô tin c·∫≠y model th·∫•p.
                </div>
              </div>
            </details>
          {% endif %}
          <div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.5);border-radius:4px;">
            <strong>üí° Khuy·∫øn ngh·ªã:</strong>
            <ul style="margin:6px 0 0 20px;padding:0;">
              <li>X√°c nh·∫≠n b√™n d∆∞·ªõi n·∫øu ƒë√¢y l√† l√° c√† chua ƒë·ªÉ c·∫£i thi·ªán h·ªá th·ªëng</li>
              <li>Ho·∫∑c th·ª≠ ch·ª•p l·∫°i v·ªõi √°nh s√°ng t·ªët h∆°n v√† g√≥c ch·ª•p r√µ r√†ng h∆°n</li>
              <li>Th·ª≠ model kh√°c ƒë·ªÉ so s√°nh k·∫øt qu·∫£ (VGG19, ResNet50, MobileNetV2, v.v.)</li>
            </ul>
          </div>
        </div>
        {% else %}
        <div style="margin:14px 0 8px 0;width:100%;">
          <span class="main-label">D·ª± ƒëo√°n ch√≠nh: {{ predicted_label }}</span>
          <span class="main-percent" style="color:#555;font-size:1.08em;">({{ (predicted_prob*100)|round(2) }}%)</span>
        </div>
        {% endif %}

        <div id="prediction-block" {% if show_feedback or possibly_not_tomato or rejected_not_tomato %}style="display:none"{% endif %}>
          <div class="prediction-list">
          {% for cname, p in probs %} 
            <div class="pred-item {% if cname == predicted_label %}is-predicted-main{% endif %}">
              <div class="pred-left">
                <div>
                  {% if cname == predicted_label %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                  {% endif %}
                  {{ cname }}
                </div>
                <div class="progress" aria-hidden="true">
                  <div class="bar {% if cname == predicted_label %}main-bar{% endif %}" style="width:{{ (p*100)|round(2) }}%">
                  </div>
                </div>
              </div>
              <div style="width:120px;text-align:right">{{ (p*100)|round(2) }}%</div>
            </div>
          {% endfor %}
          </div>
          <a href="{{ url_for('index') }}" class="back-btn">&#8592; D·ª± ƒëo√°n ·∫£nh kh√°c</a>
        </div>
      </div>
    </main>

    <aside id="disease-aside" class="result-sidebar">
      <div class="aside-columns">
        <div class="card input-card">
          <div class="input-col" style="padding:16px;">
            <h3 style="margin-top:0;">·∫¢nh ƒë√£ qua x·ª≠ l√Ω</h3>
            <img src="{{ image_path }}" class="img-preview" alt="·∫¢nh ƒë√£ x·ª≠ l√Ω">
          </div>
        </div>
        <div class="card info-card" {% if possibly_not_tomato and not show_feedback %}style="display:none"{% endif %}>
          <div style="padding:14px;">
            <div class="collapsible" onclick="toggleCollapse('disease-body')">
              <h3 style="margin:0; display:flex; align-items:center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                Th√¥ng tin b·ªánh & Ph√≤ng ng·ª´a
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon" style="margin-left: auto;"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </h3>
              <div style="font-size:0.9rem;color:var(--muted)">Chi ti·∫øt</div>
            </div>
            <div id="disease-body" class="collapse-body open"> <!-- M·∫∑c ƒë·ªãnh m·ªü -->
              <div style="margin-top:8px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff9f9)">
                <strong>{{ disease_info.name }}</strong>
                <p style="color:#444;margin-top:6px;">{{ disease_info.definition }}</p>
                <h4 style="margin:10px 0 6px 0;">C√°c bi·ªán ph√°p ph√≤ng ng·ª´a</h4>
                <ul class="prevention-list">
                  {% for tip in disease_info.prevention %}
                    <li>
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px; color: var(--leaf-600);"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                      {{ tip }}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCollapse(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle('open');
    }

    // X·ª≠ l√Ω n√∫t ph·∫£n h·ªìi
    document.addEventListener('DOMContentLoaded', function(){
      const btnNot = document.getElementById('fb-not');
      const btnYes = document.getElementById('fb-yes');
      const msg = document.getElementById('fb-msg');
      async function sendFeedback(action){
        try{
          const res = await fetch('{{ url_for('feedback') }}', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({action})
          });
          const data = await res.json();
          return data;
        }catch(e){
          return {ok:false, message:'L·ªói k·∫øt n·ªëi.'};
        }
      }

      if(btnYes) btnYes.addEventListener('click', async ()=>{
        // Ng∆∞·ªùi d√πng x√°c nh·∫≠n ·∫£nh L√Ä l√° c√† chua -> hi·ªÉn th·ªã d·ª± ƒëo√°n
        const status = await sendFeedback('confirm');
        if(status.ok){
          msg.textContent = 'C·∫£m ∆°n! Hi·ªÉn th·ªã k·∫øt qu·∫£...';
        } else {
          msg.textContent = status.message || 'ƒê√£ x√°c nh·∫≠n (kh√¥ng l∆∞u ƒë∆∞·ª£c).';
        }
        // Hi·ªÉn th·ªã kh·ªëi d·ª± ƒëo√°n v√† ·∫©n n√∫t x√°c nh·∫≠n
        const pb = document.getElementById('prediction-block');
        const cb = document.getElementById('confirm-buttons');
        if(pb) pb.style.display = 'block';
        if(cb) cb.style.display = 'none';
        
        // Hi·ªÉn th·ªã th√¥ng tin b·ªánh n·∫øu ƒëang b·ªã ·∫©n
        try{
          const aside = document.getElementById('disease-aside');
          if(aside) aside.style.display = 'block';
          const meta = document.getElementById('meta-info');
          if(meta) meta.style.display = 'block';
        }catch(e){}
        
        // ·∫®n c√°c c·∫£nh b√°o/th√¥ng b√°o t·ª´ ch·ªëi trong th·∫ª k·∫øt qu·∫£
        try{
          const alerts = document.querySelectorAll('.card.result-card .alert');
          alerts.forEach(a => a.style.display = 'none');
        }catch(e){}
        
        // X√≥a class "rejected" kh·ªèi th·∫ª k·∫øt qu·∫£ n·∫øu c√≥
        try{
          const card = document.querySelector('.card.result-card');
          if(card) card.classList.remove('rejected');
        }catch(e){}
        
        // Hi·ªÉn th·ªã th·∫ª th√¥ng tin n·∫øu ƒëang b·ªã ·∫©n
        try{
          const infoCard = document.querySelector('.card.info-card');
          if(infoCard) infoCard.style.display = 'block';
        }catch(e){}
        
        setTimeout(()=> msg.textContent = '', 3000);
      });

      if(btnNot) btnNot.addEventListener('click', async ()=>{
        // Ng∆∞·ªùi d√πng n√≥i KH√îNG ph·∫£i l√° c√† chua -> l∆∞u ph·∫£n h·ªìi v√† hi·ªán th√¥ng b√°o t·∫£i l·∫°i
        const status = await sendFeedback('not_tomato');
        const cb = document.getElementById('confirm-buttons');
        const card = document.querySelector('.card.result-card');
        const aside = document.getElementById('disease-aside');
        if(status.ok){
          // Thay n·ªôi dung th·∫ª b·∫±ng th√¥ng b√°o ng·∫Øn y√™u c·∫ßu ch·ªçn ·∫£nh kh√°c
          if(card){
            card.innerHTML = '<div style="padding:18px;"><h2>·∫¢nh kh√¥ng ph·∫£i l√° c√† chua</h2><p>Vui l√≤ng ch·ªçn l·∫°i ·∫£nh kh√°c (ch·ª•p r√µ h∆°n ho·∫∑c ch·ªçn ·∫£nh l√° th·ª±c s·ª±).</p><a href="{{ url_for('index') }}" class="back-btn">&#8592; T·∫£i ·∫£nh kh√°c</a></div>';
          }
          if(aside) aside.style.display = 'none';
        } else {
          // N·∫øu l∆∞u th·∫•t b·∫°i, v·∫´n hi·ªán th√¥ng b√°o nh∆∞ng c√≥ c·∫£nh b√°o
          if(card){
            card.innerHTML = '<div style="padding:18px;"><h2>·∫¢nh kh√¥ng ph·∫£i l√° c√† chua</h2><p>Vui l√≤ng ch·ªçn l·∫°i ·∫£nh kh√°c (ch·ª•p r√µ h∆°n ho·∫∑c ch·ªçn ·∫£nh l√° th·ª±c s·ª±).</p><div style="color:red;margin-top:6px;">L∆∞u feedback kh√¥ng th√†nh c√¥ng: '+(status.message||'Kh√¥ng x√°c ƒë·ªãnh')+'</div><a href="{{ url_for('index') }}" class="back-btn">&#8592; T·∫£i ·∫£nh kh√°c</a></div>';
          }
          if(aside) aside.style.display = 'none';
        }
      });
      // ƒê·∫£m b·∫£o khi trang hi·ªÉn th·ªã n√∫t x√°c nh·∫≠n (lu·ªìng c√≥-th·ªÉ-kh√¥ng-ph·∫£i-c√†-chua)
      // th·∫ª th√¥ng tin b·ªã ·∫©n v√† c·∫£nh b√°o hi·ªÉn th·ªã d∆∞·ªõi c√°c n√∫t.
      function enforcePossibleUI(){
        const cb = document.getElementById('confirm-buttons');
        if(!cb) return;
        const isVisible = cb.offsetParent !== null; // hi·ªÉn th·ªã trong layout
        const infoCard = document.querySelector('.card.info-card');
        const predBlock = document.getElementById('prediction-block');
        const mainLabel = document.querySelector('.main-label');
        const mainPercent = document.querySelector('.main-percent');
        if(isVisible){
          if(infoCard) infoCard.style.display = 'none';
          if(predBlock) predBlock.style.display = 'none';
          if(mainLabel) mainLabel.style.display = 'none';
          if(mainPercent) mainPercent.style.display = 'none';
          // Ch√®n c·∫£nh b√°o n·∫øu ch∆∞a c√≥
          if(!document.querySelector('.possible-warning')){
            const warn = document.createElement('div');
            warn.className = 'alert danger possible-warning';
            warn.style.margin = '10px 0 6px 0';
            warn.innerHTML = '<strong>C·∫£nh b√°o:</strong> ·∫¢nh c√≥ th·ªÉ kh√¥ng ph·∫£i l√† l√° c√† chua ho·∫∑c m√¥ t·∫£ kh√¥ng r√µ r√†ng; h·ªá th·ªëng s·∫Ω kh√¥ng ƒë∆∞a ra d·ª± ƒëo√°n ch·∫Øc ch·∫Øn. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ·∫£nh l√° r√µ r√†ng: ch·ª•p g·∫ßn l√°, ƒë·ªß s√°ng, n·ªÅn ƒë∆°n gi·∫£n.';
            cb.parentNode.insertBefore(warn, cb.nextSibling);
          }
        } else {
          if(infoCard) infoCard.style.display = '';
          if(predBlock) predBlock.style.display = '';
          if(mainLabel) mainLabel.style.display = '';
          if(mainPercent) mainPercent.style.display = '';
          const old = document.querySelector('.possible-warning');
          if(old) old.remove();
        }
      }

      // Ch·∫°y khi t·∫£i trang v√† khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c v·ªõi n√∫t ph·∫£n h·ªìi
      enforcePossibleUI();
      if(btnYes) btnYes.addEventListener('click', ()=>{
        const infoCard = document.querySelector('.card.info-card');
        if(infoCard) infoCard.style.display = '';
        const old = document.querySelector('.possible-warning'); if(old) old.remove();
      });
      if(btnNot) btnNot.addEventListener('click', ()=>{
        const old = document.querySelector('.possible-warning'); if(old) old.remove();
      });
    });
</script>
{% endblock %}
